<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>Redis | LuckyFeng的博客</title><meta name="description" content="Redis"><meta name="keywords" content="Redis"><meta name="author" content="覃烽"><meta name="copyright" content="覃烽"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="Redis"><meta name="twitter:description" content="Redis"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png"><meta property="og:type" content="article"><meta property="og:title" content="Redis"><meta property="og:url" content="http://example.com/2023/06/11/Redis/"><meta property="og:site_name" content="LuckyFeng的博客"><meta property="og:description" content="Redis"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://example.com/2023/06/11/Redis/"><link rel="prev" title="RocketMq" href="http://example.com/2023/06/11/RocketMq/"><link rel="next" title="MySQL" href="http://example.com/2023/06/11/MySQL/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'false',
  highlight_lang: 'true',
  highlight_shrink: 'false',
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  copyright: undefined,
  copy_copyright_js: false,
  ClickShowText: undefined,
  medium_zoom: 'false',
  Snackbar: undefined
  
}</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="header"> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">LuckyFeng的博客</a></span><i class="fa fa-bars fa-fw toggle-menu pull_right close" aria-hidden="true"></i><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 框架</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 其他</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></span><span class="pull_right" id="search_button"></span></div></div><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="lazyload avatar_img" src="https://s3.bmp.ovh/imgs/2021/08/537218da738c4aaa.jpg" onerror="onerror=null;src='/img/friend_404.gif'"></div><div class="mobile_post_data"><div class="mobile_data_item is_center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">44</div></a></div></div><div class="mobile_data_item is_center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">18</div></a></div></div><div class="mobile_data_item is_center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">17</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 框架</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 其他</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#Redis"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">Redis</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#1%E3%80%81%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc_mobile_items-number">1.1.</span> <span class="toc_mobile_items-text">1、分布式锁</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1-1-%E5%88%9A%E9%9C%80"><span class="toc_mobile_items-number">1.1.1.</span> <span class="toc_mobile_items-text">1.1 刚需</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1-2-%E6%BC%94%E5%8F%98"><span class="toc_mobile_items-number">1.1.2.</span> <span class="toc_mobile_items-text">1.2 演变</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1-3-Redisson"><span class="toc_mobile_items-number">1.1.3.</span> <span class="toc_mobile_items-text">1.3 Redisson</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#1-3-1-RedLock%E7%AE%97%E6%B3%95"><span class="toc_mobile_items-number">1.1.3.1.</span> <span class="toc_mobile_items-text">1.3.1 RedLock算法</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#2%E3%80%81%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc_mobile_items-number">1.2.</span> <span class="toc_mobile_items-text">2、数据类型</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2-1-String"><span class="toc_mobile_items-number">1.2.1.</span> <span class="toc_mobile_items-text">2.1 String</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2-2-List"><span class="toc_mobile_items-number">1.2.2.</span> <span class="toc_mobile_items-text">2.2 List</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2-3-Set"><span class="toc_mobile_items-number">1.2.3.</span> <span class="toc_mobile_items-text">2.3 Set</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2-4-ZSet"><span class="toc_mobile_items-number">1.2.4.</span> <span class="toc_mobile_items-text">2.4 ZSet</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2-5-bitmap"><span class="toc_mobile_items-number">1.2.5.</span> <span class="toc_mobile_items-text">2.5 bitmap</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2-6-HyperLogLog"><span class="toc_mobile_items-number">1.2.6.</span> <span class="toc_mobile_items-text">2.6 HyperLogLog</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2-7-GEO"><span class="toc_mobile_items-number">1.2.7.</span> <span class="toc_mobile_items-text">2.7 GEO</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2-8-Stream"><span class="toc_mobile_items-number">1.2.8.</span> <span class="toc_mobile_items-text">2.8 Stream</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3%E3%80%81-%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc_mobile_items-number">1.3.</span> <span class="toc_mobile_items-text">3、 持久化</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3-1-RDB"><span class="toc_mobile_items-number">1.3.1.</span> <span class="toc_mobile_items-text">3.1 RDB</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3-2-AOF"><span class="toc_mobile_items-number">1.3.2.</span> <span class="toc_mobile_items-text">3.2 AOF</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#4%E3%80%81-%E4%BA%8B%E5%8A%A1"><span class="toc_mobile_items-number">1.4.</span> <span class="toc_mobile_items-text">4、 事务</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#5%E3%80%81-%E7%AE%A1%E9%81%93"><span class="toc_mobile_items-number">1.5.</span> <span class="toc_mobile_items-text">5、 管道</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#6%E3%80%81%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85"><span class="toc_mobile_items-number">1.6.</span> <span class="toc_mobile_items-text">6、发布订阅</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#7%E3%80%81%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc_mobile_items-number">1.7.</span> <span class="toc_mobile_items-text">7、主从复制</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#8%E3%80%81%E5%93%A8%E5%85%B5-sential"><span class="toc_mobile_items-number">1.8.</span> <span class="toc_mobile_items-text">8、哨兵(sential)</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#9%E3%80%81%E9%9B%86%E7%BE%A4-cluster"><span class="toc_mobile_items-number">1.9.</span> <span class="toc_mobile_items-text">9、集群(cluster)</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#10%E3%80%81%E5%8D%95%E7%BA%BF%E7%A8%8B%EF%BC%9F%E5%A4%9A%E7%BA%BF%E7%A8%8B%EF%BC%9F"><span class="toc_mobile_items-number">1.10.</span> <span class="toc_mobile_items-text">10、单线程？多线程？</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#10-1-bigkey"><span class="toc_mobile_items-number">1.10.1.</span> <span class="toc_mobile_items-text">10.1 bigkey</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#11%E3%80%81RM%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc_mobile_items-number">1.11.</span> <span class="toc_mobile_items-text">11、RM一致性</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#11-1-cancel"><span class="toc_mobile_items-number">1.11.1.</span> <span class="toc_mobile_items-text">11.1 cancel</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#12%E3%80%81%E9%9B%AA%E5%B4%A9%E3%80%81%E7%A9%BF%E9%80%8F%E5%92%8C%E5%87%BB%E7%A9%BF"><span class="toc_mobile_items-number">1.12.</span> <span class="toc_mobile_items-text">12、雪崩、穿透和击穿</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#13%E3%80%81%E8%BF%87%E6%9C%9F%E6%B7%98%E6%B1%B0"><span class="toc_mobile_items-number">1.13.</span> <span class="toc_mobile_items-text">13、过期淘汰</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#14%E3%80%81%E4%BA%94%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0"><span class="toc_mobile_items-number">1.14.</span> <span class="toc_mobile_items-text">14、五大数据类型的底层实现</span></a></li></ol></li></ol></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis"><span class="toc-number">1.</span> <span class="toc-text">Redis</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-number">1.1.</span> <span class="toc-text">1、分布式锁</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E5%88%9A%E9%9C%80"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1 刚需</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E6%BC%94%E5%8F%98"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2 演变</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-Redisson"><span class="toc-number">1.1.3.</span> <span class="toc-text">1.3 Redisson</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-1-RedLock%E7%AE%97%E6%B3%95"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">1.3.1 RedLock算法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.2.</span> <span class="toc-text">2、数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-String"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1 String</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-List"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2 List</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-Set"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.3 Set</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-ZSet"><span class="toc-number">1.2.4.</span> <span class="toc-text">2.4 ZSet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-bitmap"><span class="toc-number">1.2.5.</span> <span class="toc-text">2.5 bitmap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-HyperLogLog"><span class="toc-number">1.2.6.</span> <span class="toc-text">2.6 HyperLogLog</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7-GEO"><span class="toc-number">1.2.7.</span> <span class="toc-text">2.7 GEO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-8-Stream"><span class="toc-number">1.2.8.</span> <span class="toc-text">2.8 Stream</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81-%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">1.3.</span> <span class="toc-text">3、 持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-RDB"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 RDB</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-AOF"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.2 AOF</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81-%E4%BA%8B%E5%8A%A1"><span class="toc-number">1.4.</span> <span class="toc-text">4、 事务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81-%E7%AE%A1%E9%81%93"><span class="toc-number">1.5.</span> <span class="toc-text">5、 管道</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6%E3%80%81%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85"><span class="toc-number">1.6.</span> <span class="toc-text">6、发布订阅</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7%E3%80%81%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-number">1.7.</span> <span class="toc-text">7、主从复制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8%E3%80%81%E5%93%A8%E5%85%B5-sential"><span class="toc-number">1.8.</span> <span class="toc-text">8、哨兵(sential)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9%E3%80%81%E9%9B%86%E7%BE%A4-cluster"><span class="toc-number">1.9.</span> <span class="toc-text">9、集群(cluster)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10%E3%80%81%E5%8D%95%E7%BA%BF%E7%A8%8B%EF%BC%9F%E5%A4%9A%E7%BA%BF%E7%A8%8B%EF%BC%9F"><span class="toc-number">1.10.</span> <span class="toc-text">10、单线程？多线程？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-1-bigkey"><span class="toc-number">1.10.1.</span> <span class="toc-text">10.1 bigkey</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11%E3%80%81RM%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-number">1.11.</span> <span class="toc-text">11、RM一致性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#11-1-cancel"><span class="toc-number">1.11.1.</span> <span class="toc-text">11.1 cancel</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12%E3%80%81%E9%9B%AA%E5%B4%A9%E3%80%81%E7%A9%BF%E9%80%8F%E5%92%8C%E5%87%BB%E7%A9%BF"><span class="toc-number">1.12.</span> <span class="toc-text">12、雪崩、穿透和击穿</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13%E3%80%81%E8%BF%87%E6%9C%9F%E6%B7%98%E6%B1%B0"><span class="toc-number">1.13.</span> <span class="toc-text">13、过期淘汰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14%E3%80%81%E4%BA%94%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.14.</span> <span class="toc-text">14、五大数据类型的底层实现</span></a></li></ol></li></ol></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png)"><div id="post-info"><div id="post-title"><div class="posttitle">Redis</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2023-06-11<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2023-06-11</time><span class="post-meta__separator mobile_hidden">|</span><span class="mobile_hidden"><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Redis/">Redis</a></span><div class="post-meta-wordcount"><i class="fa fa-file-word-o post-meta__icon" aria-hidden="true"></i><span>字数总计: </span><span class="word-count">5.7k</span><span class="post-meta__separator">|</span><i class="fa fa-clock-o post-meta__icon" aria-hidden="true"></i><span>阅读时长: 17 分钟</span><span class="post-meta__separator">|</span><i class="fa fa-eye post-meta__icon" aria-hidden="true">       </i><span>阅读量: </span><span id="busuanzi_value_page_pv"></span></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><h2 id="1、分布式锁"><a href="#1、分布式锁" class="headerlink" title="1、分布式锁"></a>1、分布式锁</h2><h3 id="1-1-刚需"><a href="#1-1-刚需" class="headerlink" title="1.1 刚需"></a>1.1 刚需</h3><ul>
<li>独占性：只能让一个线程获得。</li>
<li>高可用：不能让一个节点挂了之后，就无法获得锁或者释放锁，高并发下性能OK。</li>
<li>防死锁：杜绝死锁，必须有个超时方案或者撤销操作，有个兜底操作跳出死锁。</li>
<li>不乱抢：就是不要张冠李戴，不要乱释放别人的锁。自己的锁含着泪也要自己释放。</li>
<li>可重入：同一个节点的同一个线程获得锁之后，还可以获得锁。</li>
</ul>
<h3 id="1-2-演变"><a href="#1-2-演变" class="headerlink" title="1.2 演变"></a>1.2 演变</h3><ol>
<li><p>最垃圾的<strong>synchronized、Lock锁</strong>。原因，因为这两个锁锁住得都是不同节点的锁，所以压根不能锁住同一资源，也就是<strong>缺少独占性</strong>。</p>
</li>
<li><p>用if判断是否获取到锁，当获取不到锁时，进行停止两秒，避免频繁消耗CPU，之后递归让其重试。</p>
<p><strong>改进：递归调用可能会陷入一个StackOverflow</strong>，不太完善进一步改为以CAS的方式获取锁，失败了就停两秒让<strong>while</strong>不断重试。</p>
<p><img data-src="https://s3.bmp.ovh/imgs/2023/06/01/f1ed2f4383e559df.png" class="lazyload"></p>
</li>
<li><p><strong>部署Java的微服务宕机了，释放锁没有走到finally这一块，无法释放锁，进入死锁状态。</strong></p>
<p><strong>改进：</strong>锁设置过期时间。</p>
</li>
<li><p><strong>锁的过期时间太短可能会导致误删别人的锁。</strong>当线程A在执行任务时，此时锁过期了，线程B抢到锁，B还在执行任务，A执行任务结束，finnaly释放锁，这个时候就会删掉B的锁。</p>
<p><strong>改进：</strong>释放锁时加一个判断是否为同一个value</p>
<p><img data-src="https://s3.bmp.ovh/imgs/2023/06/01/c0b2a32d03bcc548.png" class="lazyload"></p>
</li>
<li><p><strong>判断是否为同一个锁然后再删除不是一个原子操作。</strong></p>
<p><strong>改进：</strong>使用Lua脚本，将判断和删除写在一个脚本里。</p>
<p><img data-src="https://s3.bmp.ovh/imgs/2023/06/01/fdd9c9d46dff8d8f.png" class="lazyload"></p>
</li>
<li><p><strong>可重入锁</strong>没学，</p>
</li>
<li><p><strong>自动续期：</strong>防止业务还没结束锁就过期了。另起一个异步线程，每过一段时间去监视锁是否过期，写一个Lua脚本判断是否锁还有，还有重新续上，没有直接结束。</p>
</li>
</ol>
<h3 id="1-3-Redisson"><a href="#1-3-Redisson" class="headerlink" title="1.3 Redisson"></a>1.3 Redisson</h3><h4 id="1-3-1-RedLock算法"><a href="#1-3-1-RedLock算法" class="headerlink" title="1.3.1 RedLock算法"></a>1.3.1 RedLock算法</h4><p>为了解决Redis分布式锁单点故障，导致无法获得锁或者释放锁的问题，还有一个影响就是，如果采用主从复制的分布式锁，当A线程获得master的锁，但是没有同步到slave，master就挂掉了，然后slave通过哨兵升级为master，此时B获得新的一把锁，造成一锁多键，问题很严重。为了解决这个问题：引入了红锁算法，就是多个master机器，不存在slave，当一个线程获得机器半数以上的锁时，才能正确加锁成功，否则其余不合格的锁会自动过期。一般是五个机器。</p>
<h2 id="2、数据类型"><a href="#2、数据类型" class="headerlink" title="2、数据类型"></a>2、数据类型</h2><h3 id="2-1-String"><a href="#2-1-String" class="headerlink" title="2.1 String"></a>2.1 String</h3><p><strong>功能：</strong></p>
<blockquote>
<ul>
<li>一次性设置多个键值对，或者设置多个key</li>
<li>截取value的值</li>
<li>数值增减</li>
<li>获取字符串长度和内容增加</li>
<li>分布式锁</li>
<li>先get再set</li>
</ul>
</blockquote>
<p><strong>需求：</strong></p>
<blockquote>
<ul>
<li>抖音点赞数</li>
<li>是否喜欢的文章</li>
</ul>
</blockquote>
<h3 id="2-2-List"><a href="#2-2-List" class="headerlink" title="2.2 List"></a>2.2 List</h3><p><strong>功能：</strong></p>
<blockquote>
<ul>
<li>左插右插，左出右出，双向链表</li>
<li>获取指定下标的元素和获取长度</li>
<li>截取开始到结束的元素并赋予新的key（用于分页）</li>
<li>删除N个value值</li>
<li>已有值插入新的值</li>
</ul>
</blockquote>
<p><strong>需求：</strong></p>
<blockquote>
<ul>
<li>微信公众号的订阅（用分页）</li>
</ul>
</blockquote>
<h3 id="2-3-Set"><a href="#2-3-Set" class="headerlink" title="2.3 Set"></a>2.3 Set</h3><p><strong>功能：</strong></p>
<blockquote>
<ul>
<li>一次性添加多个value</li>
<li>判断元素是否在其中、删除元素、value长度</li>
<li>随机获取一个元素，可删除或者不删除</li>
<li>并集、交集、差集</li>
</ul>
</blockquote>
<p><strong>需求：</strong></p>
<blockquote>
<ul>
<li>微信小程序抽奖</li>
<li>微信点赞查看同赞朋友</li>
<li>qq内推可能认识的人</li>
</ul>
</blockquote>
<h3 id="2-4-ZSet"><a href="#2-4-ZSet" class="headerlink" title="2.4 ZSet"></a>2.4 ZSet</h3><p><strong>功能：</strong></p>
<blockquote>
<ul>
<li>获取指定分数范围内的元素</li>
<li>获取按分数从小到大的元素</li>
<li>增加某个元素的分数</li>
<li>删除某元素、获取key的个数</li>
</ul>
</blockquote>
<p><strong>需求：</strong></p>
<p><strong>在面对需要展示最新列表、排行榜等场景时，如果数据更新频繁或者需要分页显示，建议使用ZSet</strong></p>
<blockquote>
<ul>
<li>按商品销售的数量进行排序显示</li>
</ul>
</blockquote>
<h3 id="2-5-bitmap"><a href="#2-5-bitmap" class="headerlink" title="2.5 bitmap"></a>2.5 bitmap</h3><p>需要对用户ID得到哈希值，根据哈希值除以2^32次方，得到偏移量，然后setbit 日期 偏移量（用户ID） 1，因为正常业务不可能是直接用户ID，肯定要计算出偏移量。</p>
<p><strong>功能：</strong></p>
<blockquote>
<ul>
<li>设置某一位下标为0或者1</li>
<li>统计字节数（超8位长度+1），统计有几位1</li>
<li>交集、并集</li>
</ul>
</blockquote>
<p><strong>需求：</strong></p>
<blockquote>
<ul>
<li>统计用户一年的登录次数，哪天登陆过，哪几天没登陆过</li>
<li>上下班签到统计</li>
<li>黑名单</li>
<li>日活统计</li>
<li>最近一周活跃的用户</li>
</ul>
</blockquote>
<h3 id="2-6-HyperLogLog"><a href="#2-6-HyperLogLog" class="headerlink" title="2.6 HyperLogLog"></a>2.6 HyperLogLog</h3><p><strong>统计巨大的数据</strong></p>
<p><strong>功能：</strong></p>
<blockquote>
<ul>
<li>添加元素到HyperLogLog，PFADD key value【value。。。】</li>
<li>返回估算值</li>
</ul>
</blockquote>
<p><strong>需求：</strong></p>
<blockquote>
<ul>
<li>用户搜索关键词 的数量</li>
<li>统计网站的特殊客户的访问量</li>
</ul>
</blockquote>
<h3 id="2-7-GEO"><a href="#2-7-GEO" class="headerlink" title="2.7 GEO"></a>2.7 GEO</h3><p><strong>功能：</strong></p>
<blockquote>
<ul>
<li>添加经纬度</li>
<li>获取周围半径的城市</li>
<li>获取位置和两点距离</li>
</ul>
</blockquote>
<p><strong>需求：</strong></p>
<blockquote>
<ul>
<li>美团附近酒店推送</li>
<li>高德附近核算检查点</li>
</ul>
</blockquote>
<h3 id="2-8-Stream"><a href="#2-8-Stream" class="headerlink" title="2.8 Stream"></a>2.8 Stream</h3><p>想增加MQ的功能给redis，但是比较垃圾，没有持久化，是由一种队列构成</p>
<h2 id="3、-持久化"><a href="#3、-持久化" class="headerlink" title="3、 持久化"></a>3、 持久化</h2><h3 id="3-1-RDB"><a href="#3-1-RDB" class="headerlink" title="3.1 RDB"></a>3.1 RDB</h3><p><strong>在指定时间间隔内将内存中的数据快照写入磁盘，恢复时再从快照文件中读取到内存。</strong></p>
<p>你可以修改配置文件，比如每5秒进行2次数据操作时进行数据备份，然后自动记录到RDB文件中，还有一种手动的方式，调用save/bgsave命令，</p>
<ul>
<li>save会阻塞当前主线程，直到持久化结束，执行save命令期间，redis线程不能进行其他操作，一般不用</li>
<li>bgsave在后台异步操作，不会阻塞，会fork一个跟父线程相同的子线程，由子线程进行持久化操作</li>
</ul>
<p><strong>优点：速度相对来说比AOF快，并且适合大规模的数据持久化，并且这些数据不是特别的重要，对数据的一致性不高。</strong></p>
<p><strong>缺点：当redis出现单点故障时，无法持久化最后一次的操作数据，就是可能会损失一部分的数据，因为是在一定时间间隔内做的备份，所以只能保存最近一次的快照数据</strong></p>
<h3 id="3-2-AOF"><a href="#3-2-AOF" class="headerlink" title="3.2 AOF"></a>3.2 AOF</h3><p><strong>以日志的形式记录每次写操作，读不记录，不断追加文件，但不可以改写文件，redis重启的话，根据日志文件内容将写指令从前到后执行一次完成数据的恢复工作。</strong></p>
<p><strong>流程：</strong></p>
<ol>
<li><strong>当有命令过来的时候，会先落入到AOF的一个缓存区中，这个缓冲区的作用就是为了减缓IO的次数，当到达一定命令的时候再把这些命令写入到磁盘。</strong></li>
<li><strong>AOF缓存区会根据采用的写回策略将这些指令写入到磁盘。</strong><ul>
<li><strong>每秒进行持久化操作</strong></li>
<li><strong>每次操作进行持久化操作</strong></li>
<li><strong>NO，什么都不做，采用默认的缓冲区达到一定数量的写命令，再放入到磁盘中</strong></li>
</ul>
</li>
<li><strong>因为是不断写入到AOF文件中的，所以会导致文件不断变大，这个时候会对文件进行一定的压缩处理，也就是AOF重写机制，将命令进行合并</strong><ul>
<li><strong>重写机制：</strong>对AOF文件进行压缩，只保留恢复数据的最小指令集，看不懂流程，放弃。</li>
</ul>
</li>
<li>重启时，运行AOF文件的每一条写命令</li>
</ol>
<h2 id="4、-事务"><a href="#4、-事务" class="headerlink" title="4、 事务"></a>4、 事务</h2><p>redis事务跟mysql事务存在很大的区别，不能回滚，没有隔离性，他不是mysql的要么全部执行，要么不执行。redis的事务，只<strong>保证有序性，一次性</strong>，并且他是再<strong>队列</strong>当中执行的。当有个命令出错时，不会影响其他命令的执行。</p>
<h2 id="5、-管道"><a href="#5、-管道" class="headerlink" title="5、 管道"></a>5、 管道</h2><p>优化频繁命令往返造成的性能瓶颈。一次性执行更多的redis命令，可以通过文件读取</p>
<p><strong>与传统的mset、mget命令相比，</strong></p>
<ul>
<li>原生命令是原子性、pipeline缺少原子性</li>
<li>原生命令是只能执行一种命令，而管道能读取很多命令，也可以通过文件。</li>
</ul>
<p><strong>缺点：</strong>1、缺少原子性，所以一旦有一条发生错误，无法回滚，会继续执行后面的命令，2、不能过多命令，否则可能会造成一些堵塞，因为服务器端会回复一个队列答复。</p>
<h2 id="6、发布订阅"><a href="#6、发布订阅" class="headerlink" title="6、发布订阅"></a>6、发布订阅</h2><p><strong>发布的信息不能持久化，信息丢了就没了，很垃圾，不建议采用</strong></p>
<h2 id="7、主从复制"><a href="#7、主从复制" class="headerlink" title="7、主从复制"></a>7、主从复制</h2><p>一个主节点可以对应多个从节点。主节点用来写，从节点用来读。</p>
<p><strong>复制原理和工作流程：</strong></p>
<ol>
<li><strong>配置好配置文件时，从节点会向主节点发送一个同步命令</strong></li>
<li><strong>节点收到这个同步命令的时候，就会在后台起一个线程进行RDB操作，数据备份操作，这个时候主节点肯定还是会接收到客户端传过来的写命令，就会先把这些命令放到缓存中，等到主节点持久化完成之后，从节点就会从缓存和RDB文件中进行数据复制。</strong></li>
<li><strong>主从都完成数据复制时，就会互相ping通，这个需要自己开启，默认的话每10秒进行ping</strong></li>
<li><strong>之后的话主节点有新的修改命令自动传给从节点，完成同步</strong></li>
<li>从机下线。。。</li>
</ol>
<p><strong>缺点：一个master挂掉了，会影响到其他从节点，不会自动选举出master，需要手动选配置。</strong></p>
<h2 id="8、哨兵-sential"><a href="#8、哨兵-sential" class="headerlink" title="8、哨兵(sential)"></a>8、哨兵(sential)</h2><p><strong>当一台主机器宕机的时候，哨兵就会通过投票机制，将slave选举出新的master。</strong></p>
<p><strong>流程：</strong></p>
<ol>
<li>正常运行</li>
<li>发现某台master可能要下线，<strong>两种方式判断是否下线</strong>：<ul>
<li><strong>SDown主观下线：当一台master被哨兵无法ping通时，一般在30秒，可以在配置文件进行设置，当前这台哨兵就会主观的认为这台master已经出故障了。</strong></li>
<li><strong>ODown客观下线：客观下线区别在于，当超过半数哨兵认为这台master宕机时，才会认为这台master确实出故障了，需要选举新的master。</strong></li>
</ul>
</li>
<li><strong>当真出故障时，哨兵之间会选举出兵王，让兵王去选举新的master（Raft算法）</strong><ol>
<li><strong>选举出新的master，三种选择方式</strong> <ul>
<li><strong>会根据从节点的配置文件的优先级，看哪个slave的优先级比较高</strong></li>
<li><strong>看从节点的offset，谁复制的数据最新</strong></li>
<li><strong>最后是RUN ID</strong></li>
</ul>
</li>
<li><strong>选举出来的从节点执行slaveof no one成为新的主节点，并通过slaveof命令让其他从节点成为新的master的从节点。</strong></li>
<li><strong>老master回来也会让其称为从节点</strong></li>
</ol>
</li>
</ol>
<p><strong>优点：高可用</strong></p>
<p><strong>缺点：当master挂掉时，会有一小段时间需要选举，此时不能保证数据的零丢失</strong></p>
<h2 id="9、集群-cluster"><a href="#9、集群-cluster" class="headerlink" title="9、集群(cluster)"></a>9、集群(cluster)</h2><p><strong>有多个master，master可以有多个slave。</strong></p>
<p>能干嘛：1、集群自带哨兵的故障转移，内置了高可用的支持，无需哨兵功能。2、不需要连接集群的所有节点，只需要连接一个可用节点即可。3、槽位slot负责分配各个物理节点。</p>
<p><strong>过程：当数据过来的时候，会根据CRC算法得到哈希值再模上16384得到哈希槽，再根据哈希槽分配到各个集群，因为哈希槽的范围是根据集群master的数量变化而变化的。</strong>槽位映射有三种，一般采用第三种：</p>
<ol>
<li>哈希取余分区，有多个集群哈希值对其取余得到槽位，当集群扩容或者递减时，对数据迁移影响比较大。</li>
<li>哈希环算法，目的是为了减少master数量的变化所导致数据映射的变化。哈希环本质就是【0，2^32-1】构成一个环，哈希值对这个环进行取余，就可以得到master部署的位置。当有数据过来时，就会落到哈希环上，然后看距离哪个master最近，然后这个数据就会落到哈希环上的master上，当有新的机器减少时，只会影响附近最近的master节点，扩容同理。<strong>优点：容错性和拓展性很强</strong>，<strong>缺点：当多个master落到一起时，会造成数据倾斜，有些节点的数据很多，有些节点的数据很少</strong></li>
<li><strong>哈希槽分区，CRC16（key） mod 16384</strong></li>
</ol>
<p><strong>虽然采用哈希槽算法，但是机器扩容或者减少时还是需要对哈希槽进行手动的重新分配</strong></p>
<h2 id="10、单线程？多线程？"><a href="#10、单线程？多线程？" class="headerlink" title="10、单线程？多线程？"></a>10、单线程？多线程？</h2><p><strong>实际上到5、6、7版本之后redis开始启用多线程处理其他事情，4之前一直都是单线程。① 所谓的单线程其实是主线程去处理客户端传来的网络IO和键值对读写请求，但发现多线程能够提高redis的吞吐量，比如异步删除大key，RDB、AOF，以及集群的数据同步。都是多线程的处理，缓解了主线程的压力。Redis命令工作线程是单线程的，但整个Redis是多线程的。② 但6、7版本对多线程发生了比较大的改动，因为Redis跟内存和网络带宽有关，跟CPU无关，因为多线程，无需上下文切换，但是目前内存处理数据速度非常快，所以Redis最大的性能瓶颈只能是网络带宽了，也就网络请求速度跟不上底层网络硬件的速度。为了解决这个问题，所以就引入多线程去处理网络IO请求，提高网络请求处理的并行度。但是多线程只是用来处理网络IO请求的，主线程的读写还是采用单线程，因为避免多线程出现的数据共享问题。</strong></p>
<p><strong>Redis单线程快的原因：</strong></p>
<ul>
<li><strong>基于内存：</strong>数据都在内存，且运算都是内存级别的。</li>
<li><strong>数据结构简单：</strong>redis的数据结构都是专门设计的，而这些数据结构查找和操作的时间都是O(1)级别的</li>
<li><strong>IO多路服用：</strong>利用IO多路复用监听多个socket请求，用一个线程去处理多个请求，避免了请求带来的阻塞问题。</li>
<li><strong>避免上下文切换：</strong>因为Redis工作线程是单线程的，避免了多线程的一个频繁的上下文切换，所以对数据的处理都是有序的，也避免了多线程对数据共享的问题。</li>
</ul>
<p><strong>单线程引发的问题（引入多线程的原因）：</strong></p>
<ul>
<li><strong>bigkey删除：</strong>删除的key是个非常大的对象时，比如包含了成千上万个元素的hash集合，那么del命令会造成主线程的阻塞，无法处理其他命令。<strong>解决：</strong>所以就引入了异步删除的几个命令，开启了一个线程。</li>
<li><strong>RDB持久化save命令阻塞</strong></li>
</ul>
<p><strong>网络多线程：</strong>从Redis6开始，就新增了多线程的功能来提高 I/O 的读写性能，他的主要实现思路是将主线程的 IO 读写任务拆分给一组独立的线程去执行，这样就可以使多个 socket 的读写可以并行化了，采用多路 I/O 复用技术可以让单个线程高效的处理多个连接请求（尽量减少网络IO的时间消耗），将最耗时的Socket的读取、请求解析、写入单独外包出去，剩下的命令执行仍然由主线程串行执行并和内存的数据交互。</p>
<h3 id="10-1-bigkey"><a href="#10-1-bigkey" class="headerlink" title="10.1 bigkey"></a>10.1 bigkey</h3><p><strong>String超过10kb，List，Set，ZSet等元素超过5000作为大Key。</strong></p>
<p><strong>危害：</strong></p>
<ul>
<li><p>内存不均，导致集群迁移困难</p>
</li>
<li><p>删除时，导致主线程一个阻塞</p>
</li>
<li><p>网络流量阻塞</p>
<p><strong>产生原因：</strong>社交类：粉丝数目逐级递增。汇总统计：某个报表，每年每月每日统计</p>
</li>
</ul>
<p>如何发现：提供了两个命令，一个找到bigkey，一个计算每个key占用的字节。</p>
<p><strong>如何删除bigkey</strong>：每个数据结构的删除方法不一样，String一般用del，大的花用unlink，其他特殊的数据结构可能需要逐步删除，不能一下子删除全部。</p>
<p><strong>如何优化bigkey：</strong></p>
<ul>
<li>配置文件可以优化</li>
<li>拆分处理，按照日期拆分多个。</li>
<li>过期时间尽量不要集中在一起。</li>
</ul>
<h2 id="11、RM一致性"><a href="#11、RM一致性" class="headerlink" title="11、RM一致性"></a>11、RM一致性</h2><p><strong>四种方案</strong></p>
<ol>
<li><strong>先更新MySql，在更新Redis。问题</strong>：MySQL更新结束，正准备同步到Redis时，发生异常或者网络抖动，Redis的数据没有进行更新，会导致数据不同步，比如MySQL减了1变为99，而线程Redis还是100，可能会超卖，还有一种情况是多线程引发的不同步。</li>
<li><strong>先更新缓存，在更新MySQL。问题：</strong>多线程情况下可能会导致先把Redis的操作执行结束之后，再去更新MySQL，比如先执行A、B两个线程的Redis更新操作，然后再执行MySQL的更新操作，此时可能B是最新的数据，B先更新了，A才更新，使得数据库的数据变为脏数据且和Redis的数据不同步。</li>
<li><strong>先删除缓存，在更新MySQL。问题：</strong>多线程情况下，A线程删除缓存，然后开始更新MySQL，但是执行MySQL的时间还未结束，B线程进来了，发现Redis为空，就去MySQL找，这个时候就会读取到MySQL暂未更新的值，然后B线程就去同步到Redis，这个Redis还是旧的值。造成数据不同步。<strong>解决办法：延时双删。缺点：不好设置延时时间</strong><ul>
<li><strong>延时双删：A线程处理业务的时候先删除Redis，然后去更新MySQL，更新完之后，先延时等待，也就是sleep几秒钟，等待B处理完，然后删除B可能更新的Redis，当其他线程发现Redis为空时，就会从新去MySQL找，避免了读取到Redis旧的MySQL的值</strong></li>
</ul>
</li>
<li><strong>推荐：先更新MySQL，在删除Redis。问题：</strong>A线程在更新MySQL，没有同步Redis，B线程拿到Redis旧的值，之后A才更新Redis。<strong>解决办法：</strong>MySQL更新完或者删除完的信息先放入到binlog日志中，订阅信息提取出需要的数据和key，再起另一段非业务代码获得该信息，尝试删除缓存操作，发现删除失败，将这些信息重新放入到消息队列，然后重试，重试到一定数量发现还是不能删除缓存时，这个发信息通知运维人员。如果真的要做到一致性，客户端发来的请求就要暂停，等同步完请求才能继续，非常不推荐。</li>
</ol>
<h3 id="11-1-cancel"><a href="#11-1-cancel" class="headerlink" title="11.1 cancel"></a>11.1 cancel</h3><p><strong>cancel的原理基于MySQL的主从复制。</strong></p>
<p><strong>MySQL的主从复制：当master的节点执行写操作时，会将该命令放入到binlog日志中，slave会在起一个IO Thread隔一段时间监听binlog文件是否发生改变，如果发生改变，master会为每一个IO Thread启动一个dump Thread将binlog的日志以二进制的方式发送到slave，slave接收到的二进制文件会保存到本地的relay文件中，之后slave会以启动一个SQL Thread执行本地的relay文件，进行数据同步</strong></p>
<p><strong>cancel就模仿了这个机制，让master以为cancel是一个从机，然后让master不断发送日志数据到cancel，cancel再记录到自己的日志中，从而我们可以获取到MySQL的写操作信息。</strong></p>
<h2 id="12、雪崩、穿透和击穿"><a href="#12、雪崩、穿透和击穿" class="headerlink" title="12、雪崩、穿透和击穿"></a>12、雪崩、穿透和击穿</h2><p>1、<strong>雪崩原因：</strong></p>
<ul>
<li><strong>Redis服务器挂掉了</strong></li>
<li><strong>大量的key失效</strong></li>
</ul>
<p><strong>解决和预防：</strong></p>
<ul>
<li><strong>主从复制+哨兵</strong></li>
<li><strong>集群</strong></li>
<li><strong>开启AOF和RDB，重启时快速恢复数据</strong></li>
<li><strong>key的过期时间随机</strong></li>
<li><strong>用钱阿里云服务器</strong></li>
<li><strong>多缓存结合，ehcache+redis</strong></li>
<li><strong>服务降级</strong></li>
</ul>
<hr>
<p>2、<strong>穿透原因：</strong></p>
<ul>
<li><strong>有个请求过来时发现redis和mysql都没有，就重复发起恶意请求</strong></li>
</ul>
<p><strong>解决：</strong></p>
<ul>
<li><strong>可能是恶意请求</strong><ul>
<li>**为不重复key、缺省值或者空值时，当Redis和MySQL都查不到，会在Redis做一次备份，下次过来时，Redis就会返回一个空值回去 **</li>
<li><strong>为重复key时，这个时候可能会造成redis的内存短暂飙升。因为无关紧要的key会越来越多</strong></li>
</ul>
</li>
<li><strong>布隆过滤器：对存在的key设置白名单，存在才让过去，不存在直接返回。谷歌有个Guava过滤器。会有那么百分之一会漏掉，不过无关紧要</strong></li>
</ul>
<hr>
<p>3、<strong>击穿原因：</strong></p>
<ul>
<li><strong>key的时间刚好过期，这个时候大量的请求过来</strong></li>
</ul>
<p><strong>解决：</strong></p>
<ul>
<li><strong>对重要的key设置为永不过期</strong></li>
<li><strong>双重redis缓存，A缓存负责接受数据，B缓存作为保底。</strong></li>
<li><strong>对这个数据加个互斥锁，第一个进来的时候，其他请求先等待，然后数据更新到Redis即可</strong></li>
</ul>
<h2 id="13、过期淘汰"><a href="#13、过期淘汰" class="headerlink" title="13、过期淘汰"></a>13、过期淘汰</h2><p><strong>内存设置注意事项：</strong></p>
<ul>
<li><strong>默认内存大小：0，代表不限制Redis内存使用。</strong></li>
<li><strong>一般Redis大小设置内存的四分之三。</strong></li>
<li><strong>如果超出了Redis设置的内存大小，会造成内存溢出</strong></li>
</ul>
<hr>
<p><strong>注意：当key过期时是不会立马删除的，删除会采用具体的策略。</strong></p>
<p><strong>三种删除策略</strong></p>
<ul>
<li><strong>立即删除，缺点：对CPU不友好，用处理器性能换取空间。</strong></li>
<li><strong>惰性删除，缺点：对内存不友好，用到了发现过期才删，用存储空间换取性能。</strong></li>
<li><strong>定期删除，定期抽样key，判断是否过期。</strong></li>
</ul>
<hr>
<p><strong>Redis缓存淘汰策略</strong></p>
<p><img data-src="https://s3.bmp.ovh/imgs/2023/06/01/1d0fd39bc566b19d.png" class="lazyload"></p>
<p><strong>LRU / LFU的区别：2 1 2 1 2 3 4，LRU：最后一次发生调度的时间长短。LFU：看一定时间段内页面被使用的频率!</strong></p>
<ul>
<li><strong>LRU：（Least Recently Used）最近一段时间未被使用的。</strong></li>
</ul>
<p>以下例子，3内存块：因为前面2和1有 重复，所以不算，当到4页面时，发现内存块不足，发生缺页中断，看前面最近谁没有被使用过，就是1，把1干掉4上位。</p>
<p>2    2    2    2    2    2</p>
<pre><code>  1    1    1    1    4
</code></pre>
<p>​                        3    3</p>
<ul>
<li><strong>LFU：最不常用页面置换算法</strong></li>
</ul>
<p>4发生缺页中断，往前看，发现3使用的次数最少，直接把3干掉，4上位。</p>
<p>2    2    2    2    2    2</p>
<pre><code>  1    1    1    1    1
</code></pre>
<p>​                        3    4</p>
<p><img data-src="https://s3.bmp.ovh/imgs/2023/06/01/b248b1209a15e40e.png" class="lazyload"></p>
<h2 id="14、五大数据类型的底层实现"><a href="#14、五大数据类型的底层实现" class="headerlink" title="14、五大数据类型的底层实现"></a>14、五大数据类型的底层实现</h2><p><img data-src="https://s3.bmp.ovh/imgs/2023/06/01/9360bbd01b56c6a1.png" class="lazyload"></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">覃烽</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2023/06/11/Redis/">http://example.com/2023/06/11/Redis/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com">LuckyFeng的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Redis/">Redis    </a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button"><i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg"><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2023/06/11/RocketMq/"><img class="prev_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>RocketMq</span></div></a></div><div class="next-post pull_right"><a href="/2023/06/11/MySQL/"><img class="next_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>MySQL</span></div></a></div></nav></div></div><footer id="footer" style="background-image: url(https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png)"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2023 By 覃烽</div><div class="framework-info"><span>驱动 </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script id="ribbon" src="/js/third-party/canvas-ribbon.js" size="150" alpha="0.6" zIndex="-1" mobile="true" data-click="true"></script><script id="ribbon_piao" mobile="true" src="/js/third-party/piao.js"></script><script id="canvas_nest" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="true" src="/js/third-party/canvas-nest.js"></script><script src="/js/tw_cn.js"></script><script>translateInitilization()
</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><script src="/js/third-party/click_heart.js"></script></body></html>