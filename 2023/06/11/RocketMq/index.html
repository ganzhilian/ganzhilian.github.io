<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>RocketMq | LuckyFeng的博客</title><meta name="description" content="RocketMq"><meta name="keywords" content="RocketMQ"><meta name="author" content="覃烽"><meta name="copyright" content="覃烽"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="RocketMq"><meta name="twitter:description" content="RocketMq"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png"><meta property="og:type" content="article"><meta property="og:title" content="RocketMq"><meta property="og:url" content="http://example.com/2023/06/11/RocketMq/"><meta property="og:site_name" content="LuckyFeng的博客"><meta property="og:description" content="RocketMq"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://example.com/2023/06/11/RocketMq/"><link rel="prev" title="数据结构和算法" href="http://example.com/2023/06/11/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%92%8C%E7%AE%97%E6%B3%95/"><link rel="next" title="Redis" href="http://example.com/2023/06/11/Redis/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'false',
  highlight_lang: 'true',
  highlight_shrink: 'false',
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  copyright: undefined,
  copy_copyright_js: false,
  ClickShowText: undefined,
  medium_zoom: 'false',
  Snackbar: undefined
  
}</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="header"> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">LuckyFeng的博客</a></span><i class="fa fa-bars fa-fw toggle-menu pull_right close" aria-hidden="true"></i><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 框架</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 其他</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></span><span class="pull_right" id="search_button"></span></div></div><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="lazyload avatar_img" src="https://s3.bmp.ovh/imgs/2021/08/537218da738c4aaa.jpg" onerror="onerror=null;src='/img/friend_404.gif'"></div><div class="mobile_post_data"><div class="mobile_data_item is_center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">44</div></a></div></div><div class="mobile_data_item is_center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">18</div></a></div></div><div class="mobile_data_item is_center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">17</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 框架</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 其他</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#RocketMQ"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">RocketMQ</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#%E4%B8%80%E3%80%81%E6%A6%82%E8%BF%B0"><span class="toc_mobile_items-number">1.1.</span> <span class="toc_mobile_items-text">一、概述</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1%E3%80%81%E7%AE%80%E4%BB%8B"><span class="toc_mobile_items-number">1.1.1.</span> <span class="toc_mobile_items-text">1、简介</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2%E3%80%81%E7%94%A8%E9%80%94"><span class="toc_mobile_items-number">1.1.2.</span> <span class="toc_mobile_items-text">2、用途</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#%E4%BA%8C%E3%80%81%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc_mobile_items-number">1.2.</span> <span class="toc_mobile_items-text">二、基本概念</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1%E3%80%81%E6%B6%88%E6%81%AF"><span class="toc_mobile_items-number">1.2.1.</span> <span class="toc_mobile_items-text">1、消息</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2%E3%80%81%E4%B8%BB%E9%A2%98"><span class="toc_mobile_items-number">1.2.2.</span> <span class="toc_mobile_items-text">2、主题</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3%E3%80%81%E6%A0%87%E7%AD%BE"><span class="toc_mobile_items-number">1.2.3.</span> <span class="toc_mobile_items-text">3、标签</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#4%E3%80%81%E9%98%9F%E5%88%97"><span class="toc_mobile_items-number">1.2.4.</span> <span class="toc_mobile_items-text">4、队列</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#5%E3%80%81%E6%B6%88%E6%81%AF%E6%A0%87%E8%AF%86"><span class="toc_mobile_items-number">1.2.5.</span> <span class="toc_mobile_items-text">5、消息标识</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#%E4%B8%89%E3%80%81%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84"><span class="toc_mobile_items-number">1.3.</span> <span class="toc_mobile_items-text">三、系统架构</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1%E3%80%81%E7%94%9F%E4%BA%A7%E8%80%85"><span class="toc_mobile_items-number">1.3.1.</span> <span class="toc_mobile_items-text">1、生产者</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2%E3%80%81%E6%B6%88%E8%B4%B9%E8%80%85"><span class="toc_mobile_items-number">1.3.2.</span> <span class="toc_mobile_items-text">2、消费者</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3%E3%80%81NameServer"><span class="toc_mobile_items-number">1.3.3.</span> <span class="toc_mobile_items-text">3、NameServer</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D"><span class="toc_mobile_items-number">1.3.3.1.</span> <span class="toc_mobile_items-text">功能介绍</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E8%B7%AF%E7%94%B1%E6%B3%A8%E5%86%8C"><span class="toc_mobile_items-number">1.3.3.2.</span> <span class="toc_mobile_items-text">路由注册</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E8%B7%AF%E7%94%B1%E5%89%94%E9%99%A4"><span class="toc_mobile_items-number">1.3.3.3.</span> <span class="toc_mobile_items-text">路由剔除</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E8%B7%AF%E7%94%B1%E5%8F%91%E7%8E%B0"><span class="toc_mobile_items-number">1.3.3.4.</span> <span class="toc_mobile_items-text">路由发现</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#NameServer%E9%80%89%E6%8B%A9%E7%AD%96%E7%95%A5"><span class="toc_mobile_items-number">1.3.3.5.</span> <span class="toc_mobile_items-text">NameServer选择策略</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#4%E3%80%81Broker"><span class="toc_mobile_items-number">1.3.4.</span> <span class="toc_mobile_items-text">4、Broker</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#5%E3%80%81%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc_mobile_items-number">1.3.5.</span> <span class="toc_mobile_items-text">5、执行流程</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#Topic%E7%9A%84%E5%88%9B%E5%BB%BA%E6%A8%A1%E5%BC%8F"><span class="toc_mobile_items-number">1.3.5.0.1.</span> <span class="toc_mobile_items-text">Topic的创建模式</span></a></li></ol></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#%E4%BA%8C%E3%80%81%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E7%90%86%E8%AE%BA"><span class="toc_mobile_items-number">1.4.</span> <span class="toc_mobile_items-text">二、集群搭建理论</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1%E3%80%81%E6%95%B0%E6%8D%AE%E5%A4%8D%E5%88%B6%E4%B8%8E%E5%88%B7%E7%9B%98%E7%AD%96%E7%95%A5"><span class="toc_mobile_items-number">1.4.1.</span> <span class="toc_mobile_items-text">1、数据复制与刷盘策略</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E5%A4%8D%E5%88%B6%E7%AD%96%E7%95%A5"><span class="toc_mobile_items-number">1.4.1.1.</span> <span class="toc_mobile_items-text">复制策略</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E5%88%B7%E7%9B%98%E7%AD%96%E7%95%A5"><span class="toc_mobile_items-number">1.4.1.2.</span> <span class="toc_mobile_items-text">刷盘策略</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2%E3%80%81Broker%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F"><span class="toc_mobile_items-number">1.4.2.</span> <span class="toc_mobile_items-text">2、Broker集群模式</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E5%8D%95Master"><span class="toc_mobile_items-number">1.4.2.1.</span> <span class="toc_mobile_items-text">单Master</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E5%A4%9AMaster%E5%A4%9ASlave-%E5%BC%82%E6%AD%A5%E5%A4%8D%E5%88%B6"><span class="toc_mobile_items-number">1.4.2.2.</span> <span class="toc_mobile_items-text">多Master多Slave - 异步复制</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E5%A4%9AMaster%E5%A4%9ASlave-%E5%90%8C%E6%AD%A5%E5%A4%8D%E5%88%B6"><span class="toc_mobile_items-number">1.4.2.3.</span> <span class="toc_mobile_items-text">多Master多Slave - 同步复制</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc_mobile_items-number">1.4.2.4.</span> <span class="toc_mobile_items-text">最佳实践</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#%E4%B8%89%E3%80%81%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc_mobile_items-number">1.5.</span> <span class="toc_mobile_items-text">三、工作原理</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1%E3%80%81%E6%B6%88%E6%81%AF%E7%94%9F%E4%BA%A7"><span class="toc_mobile_items-number">1.5.1.</span> <span class="toc_mobile_items-text">1、消息生产</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E6%95%B0%E6%8D%AE%E6%8A%95%E9%80%92Queue%E7%AE%97%E6%B3%95"><span class="toc_mobile_items-number">1.5.1.1.</span> <span class="toc_mobile_items-text">数据投递Queue算法</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2%E3%80%81%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8"><span class="toc_mobile_items-number">1.5.2.</span> <span class="toc_mobile_items-text">2、消息存储</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#commitlog"><span class="toc_mobile_items-number">1.5.2.1.</span> <span class="toc_mobile_items-text">commitlog</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#%E7%9B%AE%E5%BD%95%E4%B8%8E%E6%96%87%E4%BB%B6"><span class="toc_mobile_items-number">1.5.2.1.1.</span> <span class="toc_mobile_items-text">目录与文件</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#%E6%B6%88%E6%81%AF%E5%8D%95%E5%85%83"><span class="toc_mobile_items-number">1.5.2.1.2.</span> <span class="toc_mobile_items-text">消息单元</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3%E3%80%81consumequeue"><span class="toc_mobile_items-number">1.5.3.</span> <span class="toc_mobile_items-text">3、consumequeue</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E7%9B%AE%E5%BD%95%E4%B8%8E%E6%96%87%E4%BB%B6-1"><span class="toc_mobile_items-number">1.5.3.1.</span> <span class="toc_mobile_items-text">目录与文件</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E7%B4%A2%E5%BC%95%E6%9D%A1%E7%9B%AE"><span class="toc_mobile_items-number">1.5.3.2.</span> <span class="toc_mobile_items-text">索引条目</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#4%E3%80%81broker%E7%9A%84%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc_mobile_items-number">1.5.4.</span> <span class="toc_mobile_items-text">4、broker的持久化</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E6%B6%88%E6%81%AF%E5%86%99%E5%85%A5"><span class="toc_mobile_items-number">1.5.4.1.</span> <span class="toc_mobile_items-text">消息写入</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E6%B6%88%E6%81%AF%E6%8B%89%E5%8F%96"><span class="toc_mobile_items-number">1.5.4.2.</span> <span class="toc_mobile_items-text">消息拉取</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E6%80%A7%E8%83%BD%E6%8F%90%E5%8D%87"><span class="toc_mobile_items-number">1.5.4.3.</span> <span class="toc_mobile_items-text">性能提升</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#5%E3%80%81indexFile"><span class="toc_mobile_items-number">1.5.5.</span> <span class="toc_mobile_items-text">5、indexFile</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#6%E3%80%81%E6%B6%88%E6%81%AF%E7%9A%84%E6%B6%88%E8%B4%B9"><span class="toc_mobile_items-number">1.5.6.</span> <span class="toc_mobile_items-text">6、消息的消费</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E6%B6%88%E8%B4%B9%E6%96%B9%E5%BC%8F"><span class="toc_mobile_items-number">1.5.6.1.</span> <span class="toc_mobile_items-text">消费方式</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#%E6%8B%89%E5%8F%96%E6%A8%A1%E5%BC%8F"><span class="toc_mobile_items-number">1.5.6.1.1.</span> <span class="toc_mobile_items-text">拉取模式</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#%E6%8E%A8%E9%80%81%E6%A8%A1%E5%BC%8F"><span class="toc_mobile_items-number">1.5.6.1.2.</span> <span class="toc_mobile_items-text">推送模式</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E6%B6%88%E8%B4%B9%E6%A8%A1%E5%BC%8F"><span class="toc_mobile_items-number">1.5.6.2.</span> <span class="toc_mobile_items-text">消费模式</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#%E5%B9%BF%E6%92%AD%E6%B6%88%E8%B4%B9"><span class="toc_mobile_items-number">1.5.6.2.1.</span> <span class="toc_mobile_items-text">广播消费</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#%E9%9B%86%E7%BE%A4%E6%B6%88%E8%B4%B9"><span class="toc_mobile_items-number">1.5.6.2.2.</span> <span class="toc_mobile_items-text">集群消费</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E6%B6%88%E8%B4%B9%E8%BF%9B%E5%BA%A6%E4%BF%9D%E5%AD%98"><span class="toc_mobile_items-number">1.5.6.3.</span> <span class="toc_mobile_items-text">消费进度保存</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#7%E3%80%81Rebalance%E6%9C%BA%E5%88%B6"><span class="toc_mobile_items-number">1.5.7.</span> <span class="toc_mobile_items-text">7、Rebalance机制</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFRebalance"><span class="toc_mobile_items-number">1.5.7.1.</span> <span class="toc_mobile_items-text">什么是Rebalance</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E9%99%90%E5%88%B6"><span class="toc_mobile_items-number">1.5.7.2.</span> <span class="toc_mobile_items-text">限制</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E5%8D%B1%E5%AE%B3"><span class="toc_mobile_items-number">1.5.7.3.</span> <span class="toc_mobile_items-text">危害</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E4%BA%A7%E7%94%9F%E7%9A%84%E5%8E%9F%E5%9B%A0"><span class="toc_mobile_items-number">1.5.7.4.</span> <span class="toc_mobile_items-text">产生的原因</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#Rebalance%E8%BF%87%E7%A8%8B"><span class="toc_mobile_items-number">1.5.7.5.</span> <span class="toc_mobile_items-text">Rebalance过程</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#8%E3%80%81Queue%E5%88%86%E9%85%8D%E7%AE%97%E6%B3%95"><span class="toc_mobile_items-number">1.5.8.</span> <span class="toc_mobile_items-text">8、Queue分配算法</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E5%B9%B3%E5%9D%87%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5"><span class="toc_mobile_items-number">1.5.8.1.</span> <span class="toc_mobile_items-text">平均分配策略</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E7%8E%AF%E5%BD%A2%E7%AD%96%E7%95%A5"><span class="toc_mobile_items-number">1.5.8.2.</span> <span class="toc_mobile_items-text">环形策略</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C"><span class="toc_mobile_items-number">1.5.8.3.</span> <span class="toc_mobile_items-text">一致性哈希</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E6%80%BB%E7%BB%93"><span class="toc_mobile_items-number">1.5.8.4.</span> <span class="toc_mobile_items-text">总结</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E8%87%B3%E5%B0%91%E4%B8%80%E6%AC%A1%E5%8E%9F%E5%88%99"><span class="toc_mobile_items-number">1.5.8.5.</span> <span class="toc_mobile_items-text">至少一次原则</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#9%E3%80%81%E8%AE%A2%E9%98%85%E5%85%B3%E7%B3%BB%E7%9A%84%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc_mobile_items-number">1.5.9.</span> <span class="toc_mobile_items-text">9、订阅关系的一致性</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E6%AD%A3%E7%A1%AE%E8%AE%A2%E9%98%85%E5%85%B3%E7%B3%BB"><span class="toc_mobile_items-number">1.5.9.1.</span> <span class="toc_mobile_items-text">正确订阅关系</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E4%B8%8D%E6%AD%A3%E7%A1%AE%E7%9A%84%E8%AE%A2%E9%98%85%E5%85%B3%E7%B3%BB"><span class="toc_mobile_items-number">1.5.9.2.</span> <span class="toc_mobile_items-text">不正确的订阅关系</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#10%E3%80%81offset%E7%AE%A1%E7%90%86"><span class="toc_mobile_items-number">1.5.10.</span> <span class="toc_mobile_items-text">10、offset管理</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E6%9C%AC%E5%9C%B0%E7%AE%A1%E7%90%86%E6%A8%A1%E5%BC%8F"><span class="toc_mobile_items-number">1.5.10.1.</span> <span class="toc_mobile_items-text">本地管理模式</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E8%BF%9C%E7%A8%8B%E7%AE%A1%E7%90%86%E6%A8%A1%E5%BC%8F"><span class="toc_mobile_items-number">1.5.10.2.</span> <span class="toc_mobile_items-text">远程管理模式</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#offset%E8%BF%87%E7%A8%8B"><span class="toc_mobile_items-number">1.5.10.3.</span> <span class="toc_mobile_items-text">offset过程</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E9%87%8D%E8%AF%95%E9%98%9F%E5%88%97"><span class="toc_mobile_items-number">1.5.10.4.</span> <span class="toc_mobile_items-text">重试队列</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#offset%E7%9A%84%E5%90%8C%E6%AD%A5%E6%8F%90%E4%BA%A4%E4%B8%8E%E5%BC%82%E6%AD%A5%E6%8F%90%E4%BA%A4"><span class="toc_mobile_items-number">1.5.10.5.</span> <span class="toc_mobile_items-text">offset的同步提交与异步提交</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#11%E3%80%81%E6%B6%88%E6%81%AF%E7%9A%84%E5%B9%82%E7%AD%89%E6%80%A7"><span class="toc_mobile_items-number">1.5.11.</span> <span class="toc_mobile_items-text">11、消息的幂等性</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%B9%82%E7%AD%89%E6%80%A7"><span class="toc_mobile_items-number">1.5.11.1.</span> <span class="toc_mobile_items-text">什么是幂等性</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E6%B6%88%E8%B4%B9%E9%87%8D%E5%A4%8D%E7%9A%84%E5%9C%BA%E6%99%AF%E5%88%86%E6%9E%90"><span class="toc_mobile_items-number">1.5.11.2.</span> <span class="toc_mobile_items-text">消费重复的场景分析</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#%E5%8F%91%E9%80%81%E6%97%B6%E9%87%8D%E5%A4%8D"><span class="toc_mobile_items-number">1.5.11.2.1.</span> <span class="toc_mobile_items-text">发送时重复</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#%E6%B6%88%E8%B4%B9%E6%97%B6%E9%87%8D%E5%A4%8D"><span class="toc_mobile_items-number">1.5.11.2.2.</span> <span class="toc_mobile_items-text">消费时重复</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#Rebalance%E6%97%B6%E9%87%8D%E5%A4%8D"><span class="toc_mobile_items-number">1.5.11.2.3.</span> <span class="toc_mobile_items-text">Rebalance时重复</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#%E4%BB%A5%E4%B8%8B%E6%98%AFJava%E6%83%85%E5%86%B5"><span class="toc_mobile_items-number">1.5.11.2.4.</span> <span class="toc_mobile_items-text">以下是Java情况</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E9%80%9A%E7%94%A8%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc_mobile_items-number">1.5.11.3.</span> <span class="toc_mobile_items-text">通用解决方案</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#12%E3%80%81%E6%B6%88%E6%81%AF%E5%A0%86%E7%A7%AF%E4%B8%8E%E6%B6%88%E8%B4%B9%E5%BB%B6%E8%BF%9F"><span class="toc_mobile_items-number">1.5.12.</span> <span class="toc_mobile_items-text">12、消息堆积与消费延迟</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc_mobile_items-number">1.5.12.1.</span> <span class="toc_mobile_items-text">概念</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E4%BA%A7%E7%94%9F%E5%8E%9F%E5%9B%A0"><span class="toc_mobile_items-number">1.5.12.2.</span> <span class="toc_mobile_items-text">产生原因</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#%E7%BB%93%E8%AE%BA"><span class="toc_mobile_items-number">1.5.12.2.1.</span> <span class="toc_mobile_items-text">结论</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E6%B6%88%E8%B4%B9%E8%80%97%E6%97%B6"><span class="toc_mobile_items-number">1.5.12.3.</span> <span class="toc_mobile_items-text">消费耗时</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E6%B6%88%E8%B4%B9%E5%B9%B6%E5%8F%91%E5%BA%A6"><span class="toc_mobile_items-number">1.5.12.4.</span> <span class="toc_mobile_items-text">消费并发度</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E5%A6%82%E4%BD%95%E9%81%BF%E5%85%8D"><span class="toc_mobile_items-number">1.5.12.5.</span> <span class="toc_mobile_items-text">如何避免</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#%E6%B6%88%E8%80%97%E5%B9%B6%E5%8F%91%E5%BA%A6%EF%BC%9A"><span class="toc_mobile_items-number">1.5.12.5.1.</span> <span class="toc_mobile_items-text">消耗并发度：</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#13%E3%80%81%E6%B6%88%E6%81%AF%E7%9A%84%E6%B8%85%E7%90%86"><span class="toc_mobile_items-number">1.5.13.</span> <span class="toc_mobile_items-text">13、消息的清理</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#%E5%9B%9B%E3%80%81%E5%BA%94%E7%94%A8"><span class="toc_mobile_items-number">1.6.</span> <span class="toc_mobile_items-text">四、应用</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1%E3%80%81%E6%99%AE%E9%80%9A%E6%B6%88%E6%81%AF"><span class="toc_mobile_items-number">1.6.1.</span> <span class="toc_mobile_items-text">1、普通消息</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E5%90%8C%E6%AD%A5%E5%8F%91%E9%80%81"><span class="toc_mobile_items-number">1.6.1.1.</span> <span class="toc_mobile_items-text">同步发送</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E5%BC%82%E6%AD%A5%E5%8F%91%E9%80%81"><span class="toc_mobile_items-number">1.6.1.2.</span> <span class="toc_mobile_items-text">异步发送</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E5%8D%95%E5%90%91%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF"><span class="toc_mobile_items-number">1.6.1.3.</span> <span class="toc_mobile_items-text">单向发送消息</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2%E3%80%81%E9%A1%BA%E5%BA%8F%E6%B6%88%E6%81%AF"><span class="toc_mobile_items-number">1.6.2.</span> <span class="toc_mobile_items-text">2、顺序消息</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E9%A1%BA%E5%BA%8F%E6%B6%88%E6%81%AF"><span class="toc_mobile_items-number">1.6.2.1.</span> <span class="toc_mobile_items-text">为什么需要顺序消息</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E6%9C%89%E5%BA%8F%E6%80%A7%E5%88%86%E7%B1%BB"><span class="toc_mobile_items-number">1.6.2.2.</span> <span class="toc_mobile_items-text">有序性分类</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E5%85%A8%E5%B1%80%E6%9C%89%E5%BA%8F"><span class="toc_mobile_items-number">1.6.2.3.</span> <span class="toc_mobile_items-text">全局有序</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E5%88%86%E5%8C%BA%E6%9C%89%E5%BA%8F"><span class="toc_mobile_items-number">1.6.2.4.</span> <span class="toc_mobile_items-text">分区有序</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3%E3%80%81%E5%BB%B6%E6%97%B6%E6%B6%88%E6%81%AF"><span class="toc_mobile_items-number">1.6.3.</span> <span class="toc_mobile_items-text">3、延时消息</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E5%BB%B6%E6%97%B6%E7%AD%89%E7%BA%A7"><span class="toc_mobile_items-number">1.6.3.1.</span> <span class="toc_mobile_items-text">延时等级</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc_mobile_items-number">1.6.3.2.</span> <span class="toc_mobile_items-text">实现原理</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#4%E3%80%81%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF"><span class="toc_mobile_items-number">1.6.4.</span> <span class="toc_mobile_items-text">4、事务消息</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#5%E3%80%81%E6%89%B9%E9%87%8F%E6%B6%88%E6%81%AF"><span class="toc_mobile_items-number">1.6.5.</span> <span class="toc_mobile_items-text">5、批量消息</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E5%AD%98%E5%9C%A8%E9%97%AE%E9%A2%98"><span class="toc_mobile_items-number">1.6.5.1.</span> <span class="toc_mobile_items-text">存在问题</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#6%E3%80%81%E6%B6%88%E6%81%AF%E8%BF%87%E6%BB%A4"><span class="toc_mobile_items-number">1.6.6.</span> <span class="toc_mobile_items-text">6、消息过滤</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#Tag%E8%BF%87%E6%BB%A4"><span class="toc_mobile_items-number">1.6.6.1.</span> <span class="toc_mobile_items-text">Tag过滤</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#SQL%E8%BF%87%E6%BB%A4"><span class="toc_mobile_items-number">1.6.6.2.</span> <span class="toc_mobile_items-text">SQL过滤</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#7%E3%80%81%E6%B6%88%E6%81%AF%E9%87%8D%E8%AF%95"><span class="toc_mobile_items-number">1.6.7.</span> <span class="toc_mobile_items-text">7、消息重试</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E9%A1%BA%E5%BA%8F%E6%B6%88%E6%81%AF"><span class="toc_mobile_items-number">1.6.7.1.</span> <span class="toc_mobile_items-text">顺序消息</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E6%97%A0%E5%BA%8F%E6%B6%88%E6%81%AF"><span class="toc_mobile_items-number">1.6.7.2.</span> <span class="toc_mobile_items-text">无序消息</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E9%87%8D%E8%AF%95%E9%98%9F%E5%88%97-1"><span class="toc_mobile_items-number">1.6.7.3.</span> <span class="toc_mobile_items-text">重试队列</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E9%87%8D%E8%AF%95%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F"><span class="toc_mobile_items-number">1.6.7.4.</span> <span class="toc_mobile_items-text">重试配置方式</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E4%B8%8D%E9%87%8D%E8%AF%95%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F%E3%80%81"><span class="toc_mobile_items-number">1.6.7.5.</span> <span class="toc_mobile_items-text">不重试配置方式、</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#8%E3%80%81%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97"><span class="toc_mobile_items-number">1.6.8.</span> <span class="toc_mobile_items-text">8、死信队列</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E7%89%B9%E5%BE%81"><span class="toc_mobile_items-number">1.6.8.1.</span> <span class="toc_mobile_items-text">特征</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#%E5%A4%84%E7%90%86"><span class="toc_mobile_items-number">1.6.8.2.</span> <span class="toc_mobile_items-text">处理</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#RocketMQ"><span class="toc-number">1.</span> <span class="toc-text">RocketMQ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E6%A6%82%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">一、概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.1.</span> <span class="toc-text">1、简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E7%94%A8%E9%80%94"><span class="toc-number">1.1.2.</span> <span class="toc-text">2、用途</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">1.2.</span> <span class="toc-text">二、基本概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E6%B6%88%E6%81%AF"><span class="toc-number">1.2.1.</span> <span class="toc-text">1、消息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E4%B8%BB%E9%A2%98"><span class="toc-number">1.2.2.</span> <span class="toc-text">2、主题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E6%A0%87%E7%AD%BE"><span class="toc-number">1.2.3.</span> <span class="toc-text">3、标签</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E9%98%9F%E5%88%97"><span class="toc-number">1.2.4.</span> <span class="toc-text">4、队列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E6%B6%88%E6%81%AF%E6%A0%87%E8%AF%86"><span class="toc-number">1.2.5.</span> <span class="toc-text">5、消息标识</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84"><span class="toc-number">1.3.</span> <span class="toc-text">三、系统架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E7%94%9F%E4%BA%A7%E8%80%85"><span class="toc-number">1.3.1.</span> <span class="toc-text">1、生产者</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E6%B6%88%E8%B4%B9%E8%80%85"><span class="toc-number">1.3.2.</span> <span class="toc-text">2、消费者</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81NameServer"><span class="toc-number">1.3.3.</span> <span class="toc-text">3、NameServer</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">功能介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E6%B3%A8%E5%86%8C"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">路由注册</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E5%89%94%E9%99%A4"><span class="toc-number">1.3.3.3.</span> <span class="toc-text">路由剔除</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E5%8F%91%E7%8E%B0"><span class="toc-number">1.3.3.4.</span> <span class="toc-text">路由发现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NameServer%E9%80%89%E6%8B%A9%E7%AD%96%E7%95%A5"><span class="toc-number">1.3.3.5.</span> <span class="toc-text">NameServer选择策略</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81Broker"><span class="toc-number">1.3.4.</span> <span class="toc-text">4、Broker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.3.5.</span> <span class="toc-text">5、执行流程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Topic%E7%9A%84%E5%88%9B%E5%BB%BA%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.3.5.0.1.</span> <span class="toc-text">Topic的创建模式</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E7%90%86%E8%AE%BA"><span class="toc-number">1.4.</span> <span class="toc-text">二、集群搭建理论</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E6%95%B0%E6%8D%AE%E5%A4%8D%E5%88%B6%E4%B8%8E%E5%88%B7%E7%9B%98%E7%AD%96%E7%95%A5"><span class="toc-number">1.4.1.</span> <span class="toc-text">1、数据复制与刷盘策略</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6%E7%AD%96%E7%95%A5"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">复制策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%B7%E7%9B%98%E7%AD%96%E7%95%A5"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">刷盘策略</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81Broker%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.4.2.</span> <span class="toc-text">2、Broker集群模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95Master"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">单Master</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9AMaster%E5%A4%9ASlave-%E5%BC%82%E6%AD%A5%E5%A4%8D%E5%88%B6"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">多Master多Slave - 异步复制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9AMaster%E5%A4%9ASlave-%E5%90%8C%E6%AD%A5%E5%A4%8D%E5%88%B6"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">多Master多Slave - 同步复制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.4.2.4.</span> <span class="toc-text">最佳实践</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">1.5.</span> <span class="toc-text">三、工作原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E6%B6%88%E6%81%AF%E7%94%9F%E4%BA%A7"><span class="toc-number">1.5.1.</span> <span class="toc-text">1、消息生产</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%8A%95%E9%80%92Queue%E7%AE%97%E6%B3%95"><span class="toc-number">1.5.1.1.</span> <span class="toc-text">数据投递Queue算法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8"><span class="toc-number">1.5.2.</span> <span class="toc-text">2、消息存储</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#commitlog"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">commitlog</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E4%B8%8E%E6%96%87%E4%BB%B6"><span class="toc-number">1.5.2.1.1.</span> <span class="toc-text">目录与文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E5%8D%95%E5%85%83"><span class="toc-number">1.5.2.1.2.</span> <span class="toc-text">消息单元</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81consumequeue"><span class="toc-number">1.5.3.</span> <span class="toc-text">3、consumequeue</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E4%B8%8E%E6%96%87%E4%BB%B6-1"><span class="toc-number">1.5.3.1.</span> <span class="toc-text">目录与文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E6%9D%A1%E7%9B%AE"><span class="toc-number">1.5.3.2.</span> <span class="toc-text">索引条目</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81broker%E7%9A%84%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">1.5.4.</span> <span class="toc-text">4、broker的持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E5%86%99%E5%85%A5"><span class="toc-number">1.5.4.1.</span> <span class="toc-text">消息写入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E6%8B%89%E5%8F%96"><span class="toc-number">1.5.4.2.</span> <span class="toc-text">消息拉取</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E6%8F%90%E5%8D%87"><span class="toc-number">1.5.4.3.</span> <span class="toc-text">性能提升</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81indexFile"><span class="toc-number">1.5.5.</span> <span class="toc-text">5、indexFile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E6%B6%88%E6%81%AF%E7%9A%84%E6%B6%88%E8%B4%B9"><span class="toc-number">1.5.6.</span> <span class="toc-text">6、消息的消费</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E6%96%B9%E5%BC%8F"><span class="toc-number">1.5.6.1.</span> <span class="toc-text">消费方式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8B%89%E5%8F%96%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.5.6.1.1.</span> <span class="toc-text">拉取模式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8E%A8%E9%80%81%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.5.6.1.2.</span> <span class="toc-text">推送模式</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.5.6.2.</span> <span class="toc-text">消费模式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B9%BF%E6%92%AD%E6%B6%88%E8%B4%B9"><span class="toc-number">1.5.6.2.1.</span> <span class="toc-text">广播消费</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%B6%88%E8%B4%B9"><span class="toc-number">1.5.6.2.2.</span> <span class="toc-text">集群消费</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%BF%9B%E5%BA%A6%E4%BF%9D%E5%AD%98"><span class="toc-number">1.5.6.3.</span> <span class="toc-text">消费进度保存</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7%E3%80%81Rebalance%E6%9C%BA%E5%88%B6"><span class="toc-number">1.5.7.</span> <span class="toc-text">7、Rebalance机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFRebalance"><span class="toc-number">1.5.7.1.</span> <span class="toc-text">什么是Rebalance</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%99%90%E5%88%B6"><span class="toc-number">1.5.7.2.</span> <span class="toc-text">限制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%B1%E5%AE%B3"><span class="toc-number">1.5.7.3.</span> <span class="toc-text">危害</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%A7%E7%94%9F%E7%9A%84%E5%8E%9F%E5%9B%A0"><span class="toc-number">1.5.7.4.</span> <span class="toc-text">产生的原因</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Rebalance%E8%BF%87%E7%A8%8B"><span class="toc-number">1.5.7.5.</span> <span class="toc-text">Rebalance过程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8%E3%80%81Queue%E5%88%86%E9%85%8D%E7%AE%97%E6%B3%95"><span class="toc-number">1.5.8.</span> <span class="toc-text">8、Queue分配算法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B9%B3%E5%9D%87%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5"><span class="toc-number">1.5.8.1.</span> <span class="toc-text">平均分配策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8E%AF%E5%BD%A2%E7%AD%96%E7%95%A5"><span class="toc-number">1.5.8.2.</span> <span class="toc-text">环形策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C"><span class="toc-number">1.5.8.3.</span> <span class="toc-text">一致性哈希</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.5.8.4.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%B3%E5%B0%91%E4%B8%80%E6%AC%A1%E5%8E%9F%E5%88%99"><span class="toc-number">1.5.8.5.</span> <span class="toc-text">至少一次原则</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9%E3%80%81%E8%AE%A2%E9%98%85%E5%85%B3%E7%B3%BB%E7%9A%84%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-number">1.5.9.</span> <span class="toc-text">9、订阅关系的一致性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A3%E7%A1%AE%E8%AE%A2%E9%98%85%E5%85%B3%E7%B3%BB"><span class="toc-number">1.5.9.1.</span> <span class="toc-text">正确订阅关系</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8D%E6%AD%A3%E7%A1%AE%E7%9A%84%E8%AE%A2%E9%98%85%E5%85%B3%E7%B3%BB"><span class="toc-number">1.5.9.2.</span> <span class="toc-text">不正确的订阅关系</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10%E3%80%81offset%E7%AE%A1%E7%90%86"><span class="toc-number">1.5.10.</span> <span class="toc-text">10、offset管理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E7%AE%A1%E7%90%86%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.5.10.1.</span> <span class="toc-text">本地管理模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E7%AE%A1%E7%90%86%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.5.10.2.</span> <span class="toc-text">远程管理模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#offset%E8%BF%87%E7%A8%8B"><span class="toc-number">1.5.10.3.</span> <span class="toc-text">offset过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%8D%E8%AF%95%E9%98%9F%E5%88%97"><span class="toc-number">1.5.10.4.</span> <span class="toc-text">重试队列</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#offset%E7%9A%84%E5%90%8C%E6%AD%A5%E6%8F%90%E4%BA%A4%E4%B8%8E%E5%BC%82%E6%AD%A5%E6%8F%90%E4%BA%A4"><span class="toc-number">1.5.10.5.</span> <span class="toc-text">offset的同步提交与异步提交</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11%E3%80%81%E6%B6%88%E6%81%AF%E7%9A%84%E5%B9%82%E7%AD%89%E6%80%A7"><span class="toc-number">1.5.11.</span> <span class="toc-text">11、消息的幂等性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%B9%82%E7%AD%89%E6%80%A7"><span class="toc-number">1.5.11.1.</span> <span class="toc-text">什么是幂等性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E9%87%8D%E5%A4%8D%E7%9A%84%E5%9C%BA%E6%99%AF%E5%88%86%E6%9E%90"><span class="toc-number">1.5.11.2.</span> <span class="toc-text">消费重复的场景分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E6%97%B6%E9%87%8D%E5%A4%8D"><span class="toc-number">1.5.11.2.1.</span> <span class="toc-text">发送时重复</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E6%97%B6%E9%87%8D%E5%A4%8D"><span class="toc-number">1.5.11.2.2.</span> <span class="toc-text">消费时重复</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Rebalance%E6%97%B6%E9%87%8D%E5%A4%8D"><span class="toc-number">1.5.11.2.3.</span> <span class="toc-text">Rebalance时重复</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%A5%E4%B8%8B%E6%98%AFJava%E6%83%85%E5%86%B5"><span class="toc-number">1.5.11.2.4.</span> <span class="toc-text">以下是Java情况</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E7%94%A8%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">1.5.11.3.</span> <span class="toc-text">通用解决方案</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12%E3%80%81%E6%B6%88%E6%81%AF%E5%A0%86%E7%A7%AF%E4%B8%8E%E6%B6%88%E8%B4%B9%E5%BB%B6%E8%BF%9F"><span class="toc-number">1.5.12.</span> <span class="toc-text">12、消息堆积与消费延迟</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-number">1.5.12.1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%A7%E7%94%9F%E5%8E%9F%E5%9B%A0"><span class="toc-number">1.5.12.2.</span> <span class="toc-text">产生原因</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%93%E8%AE%BA"><span class="toc-number">1.5.12.2.1.</span> <span class="toc-text">结论</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%97%E6%97%B6"><span class="toc-number">1.5.12.3.</span> <span class="toc-text">消费耗时</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E5%B9%B6%E5%8F%91%E5%BA%A6"><span class="toc-number">1.5.12.4.</span> <span class="toc-text">消费并发度</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E9%81%BF%E5%85%8D"><span class="toc-number">1.5.12.5.</span> <span class="toc-text">如何避免</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B6%88%E8%80%97%E5%B9%B6%E5%8F%91%E5%BA%A6%EF%BC%9A"><span class="toc-number">1.5.12.5.1.</span> <span class="toc-text">消耗并发度：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13%E3%80%81%E6%B6%88%E6%81%AF%E7%9A%84%E6%B8%85%E7%90%86"><span class="toc-number">1.5.13.</span> <span class="toc-text">13、消息的清理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%BA%94%E7%94%A8"><span class="toc-number">1.6.</span> <span class="toc-text">四、应用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E6%99%AE%E9%80%9A%E6%B6%88%E6%81%AF"><span class="toc-number">1.6.1.</span> <span class="toc-text">1、普通消息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E5%8F%91%E9%80%81"><span class="toc-number">1.6.1.1.</span> <span class="toc-text">同步发送</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E5%8F%91%E9%80%81"><span class="toc-number">1.6.1.2.</span> <span class="toc-text">异步发送</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E5%90%91%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF"><span class="toc-number">1.6.1.3.</span> <span class="toc-text">单向发送消息</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E9%A1%BA%E5%BA%8F%E6%B6%88%E6%81%AF"><span class="toc-number">1.6.2.</span> <span class="toc-text">2、顺序消息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E9%A1%BA%E5%BA%8F%E6%B6%88%E6%81%AF"><span class="toc-number">1.6.2.1.</span> <span class="toc-text">为什么需要顺序消息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%89%E5%BA%8F%E6%80%A7%E5%88%86%E7%B1%BB"><span class="toc-number">1.6.2.2.</span> <span class="toc-text">有序性分类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E6%9C%89%E5%BA%8F"><span class="toc-number">1.6.2.3.</span> <span class="toc-text">全局有序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E5%8C%BA%E6%9C%89%E5%BA%8F"><span class="toc-number">1.6.2.4.</span> <span class="toc-text">分区有序</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E5%BB%B6%E6%97%B6%E6%B6%88%E6%81%AF"><span class="toc-number">1.6.3.</span> <span class="toc-text">3、延时消息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BB%B6%E6%97%B6%E7%AD%89%E7%BA%A7"><span class="toc-number">1.6.3.1.</span> <span class="toc-text">延时等级</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">1.6.3.2.</span> <span class="toc-text">实现原理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF"><span class="toc-number">1.6.4.</span> <span class="toc-text">4、事务消息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E6%89%B9%E9%87%8F%E6%B6%88%E6%81%AF"><span class="toc-number">1.6.5.</span> <span class="toc-text">5、批量消息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%98%E5%9C%A8%E9%97%AE%E9%A2%98"><span class="toc-number">1.6.5.1.</span> <span class="toc-text">存在问题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E6%B6%88%E6%81%AF%E8%BF%87%E6%BB%A4"><span class="toc-number">1.6.6.</span> <span class="toc-text">6、消息过滤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Tag%E8%BF%87%E6%BB%A4"><span class="toc-number">1.6.6.1.</span> <span class="toc-text">Tag过滤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SQL%E8%BF%87%E6%BB%A4"><span class="toc-number">1.6.6.2.</span> <span class="toc-text">SQL过滤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7%E3%80%81%E6%B6%88%E6%81%AF%E9%87%8D%E8%AF%95"><span class="toc-number">1.6.7.</span> <span class="toc-text">7、消息重试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A1%BA%E5%BA%8F%E6%B6%88%E6%81%AF"><span class="toc-number">1.6.7.1.</span> <span class="toc-text">顺序消息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A0%E5%BA%8F%E6%B6%88%E6%81%AF"><span class="toc-number">1.6.7.2.</span> <span class="toc-text">无序消息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%8D%E8%AF%95%E9%98%9F%E5%88%97-1"><span class="toc-number">1.6.7.3.</span> <span class="toc-text">重试队列</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%8D%E8%AF%95%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F"><span class="toc-number">1.6.7.4.</span> <span class="toc-text">重试配置方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8D%E9%87%8D%E8%AF%95%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F%E3%80%81"><span class="toc-number">1.6.7.5.</span> <span class="toc-text">不重试配置方式、</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8%E3%80%81%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97"><span class="toc-number">1.6.8.</span> <span class="toc-text">8、死信队列</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%B9%E5%BE%81"><span class="toc-number">1.6.8.1.</span> <span class="toc-text">特征</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%84%E7%90%86"><span class="toc-number">1.6.8.2.</span> <span class="toc-text">处理</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png)"><div id="post-info"><div id="post-title"><div class="posttitle">RocketMq</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2023-06-11<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2023-06-11</time><span class="post-meta__separator mobile_hidden">|</span><span class="mobile_hidden"><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/RocketMQ/">RocketMQ</a></span><div class="post-meta-wordcount"><i class="fa fa-file-word-o post-meta__icon" aria-hidden="true"></i><span>字数总计: </span><span class="word-count">10.6k</span><span class="post-meta__separator">|</span><i class="fa fa-clock-o post-meta__icon" aria-hidden="true"></i><span>阅读时长: 32 分钟</span><span class="post-meta__separator">|</span><i class="fa fa-eye post-meta__icon" aria-hidden="true">       </i><span>阅读量: </span><span id="busuanzi_value_page_pv"></span></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h1 id="RocketMQ"><a href="#RocketMQ" class="headerlink" title="RocketMQ"></a>RocketMQ</h1><p>学习视频：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1cf4y157sz/?spm_id_from=333.999.0.0">https://www.bilibili.com/video/BV1cf4y157sz/?spm_id_from=333.999.0.0</a></p>
<h2 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h2><h3 id="1、简介"><a href="#1、简介" class="headerlink" title="1、简介"></a>1、简介</h3><blockquote>
<p>就是一个高可用、高并发、高可靠、低延迟的分布式的消息中间件，给消息提供了生产，存储，消费的软件。</p>
</blockquote>
<h3 id="2、用途"><a href="#2、用途" class="headerlink" title="2、用途"></a>2、用途</h3><ul>
<li><p><strong>流量削锋：</strong>当大量的请求打过来的时候，可以先把这些请求放入到MQ中，避免造成系统的阻塞或者数据库的崩溃。</p>
</li>
<li><p><strong>异步解耦：</strong>上游戏对下游系统的同步调用，导致系统的效率低下并且吞吐量低，耦合度还高。一般这种的话可以通过异步调用解决，两层之间换成异步调用，一般的做法是，中间加一个MQ。</p>
<p>学习博客：<a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000038844218">https://segmentfault.com/a/1190000038844218</a></p>
<p><strong>比如：</strong>一个业务的需求是：当用户注册成功时，发送短信或者邮箱提示。</p>
<ul>
<li>同步方案：用户信息落入到注册系统时，在同步调用发短信功能，在调用邮箱功能，然后邮箱发送成功了，在返回告诉短信功能，短信成功了，在返回告诉注册系统，在返回给用户注册成功。对用户体验很糟糕。</li>
</ul>
</li>
<li><p>并行方案：将短信发送和邮箱发送交给不同的线程去处理，等到这两个业务都处理完了，在返回告诉注册系统，注册系统在返回给用户。</p>
<ul>
<li><strong>异步调用：</strong>用户将信息落入到注册系统时，直接返回告诉用户注册成功，然后注册系统再把信息放入到MQ，MQ再把信息分发到不同的消费者，也就是邮箱和短信的发送功能。</li>
</ul>
</li>
<li><p><strong>数据收集：</strong>对这些海量的数据进行实时或者批量汇总，进行大数据分析。</p>
</li>
</ul>
<h2 id="二、基本概念"><a href="#二、基本概念" class="headerlink" title="二、基本概念"></a>二、基本概念</h2><h3 id="1、消息"><a href="#1、消息" class="headerlink" title="1、消息"></a>1、消息</h3><p>message：就是一条数据，有生产者生产，消费者消费。</p>
<h3 id="2、主题"><a href="#2、主题" class="headerlink" title="2、主题"></a>2、主题</h3><p><strong>Topic：</strong>就是一堆消息的集合，每个消息只属于一个Topic。</p>
<h3 id="3、标签"><a href="#3、标签" class="headerlink" title="3、标签"></a>3、标签</h3><p><strong>Tag：</strong>相当于对消息的一个二级分类，比如一个消息有Topic动物或者Topic植物，则动物的Tag可以是人、狗、猫等。植物的Tag可以是玫瑰、向日葵等。*代表接受某Topic的全部消息。</p>
<h3 id="4、队列"><a href="#4、队列" class="headerlink" title="4、队列"></a>4、队列</h3><p><strong>Queue：</strong>用于存放消息的实体。一个Queue只能允许一个消费组中的一个消费者消费，但能不同消费组的一个消费者消费同一个Queue。</p>
<h3 id="5、消息标识"><a href="#5、消息标识" class="headerlink" title="5、消息标识"></a>5、消息标识</h3><p><strong>messageId：</strong>分两种信息。</p>
<ul>
<li><p>msgId：由生产者生产，具有一定的唯一性，小概率会重复。</p>
<p>producerIp + 进程pid + MessageClientIDSetter类的ClassLoader的hashCode +<br>当前时间 + AutomicInteger自增计数器</p>
</li>
<li><p>offsetId：由消费者提供，用于查看消费者消费到了哪条数据。</p>
<p>brokerIp + 物理分区的offset（Queue中的<br>偏移量</p>
</li>
</ul>
<p><strong>keyId：</strong>用户指定的唯一标识，当用户需要查询某条消息时，可以通过keyId查询。</p>
<h2 id="三、系统架构"><a href="#三、系统架构" class="headerlink" title="三、系统架构"></a>三、系统架构</h2><p><img data-src="https://s3.bmp.ovh/imgs/2023/06/05/04125b880f21a2c2.png" class="lazyload"></p>
<h3 id="1、生产者"><a href="#1、生产者" class="headerlink" title="1、生产者"></a>1、生产者</h3><p>用户消息的生产。生产生产的消息通过MQ的负载均衡选择相应的Broker集群队列进行投递。一般生产者是以生产者组的形式生产消息，生产者组发送同一Topic类型的消息。一个生产者组可以发送多个Topic的消息。</p>
<h3 id="2、消费者"><a href="#2、消费者" class="headerlink" title="2、消费者"></a>2、消费者</h3><p>消息的消费。一个消息从Broker队列里面获得消息，并对消息执行相应的业务。消费者一般都是再消费者组里出现，实现了负载均衡（将一个Topic的不同Queue交给消费者组里的不同消费者进行消费）和容错（一个消费者挂了，消费者组里的其他消费者可以接着他的信息消费）</p>
<p><img data-src="https://s3.bmp.ovh/imgs/2023/06/05/ae30bb9fec6b0b37.png" class="lazyload"> </p>
<p><strong>注意：</strong></p>
<ul>
<li><strong>消费者组的消费者比Topic的队列多时，会造成资源浪费</strong>，多出来的消费者不会消费，因为一个消费者只能对应一个队列，所以尽量保持队列和消费者1：1的关系</li>
<li><strong>一个消费者组只能消费一个Topic</strong></li>
<li><strong>不同的消费者组可以消费同一Topic的队列</strong></li>
</ul>
<h3 id="3、NameServer"><a href="#3、NameServer" class="headerlink" title="3、NameServer"></a>3、NameServer</h3><h4 id="功能介绍"><a href="#功能介绍" class="headerlink" title="功能介绍"></a>功能介绍</h4><p>就是一个注册中心，主要有<strong>两个功能</strong>：</p>
<ul>
<li><strong>Broker管理：</strong>每个NameServer中维护者Broker列表，记录他们的信息，BrokerId，提供心跳机制，检查是否存活。</li>
<li><strong>路由信息管理：</strong>客户端（生产者和消费者）不可能直接通过Broker的连接，毕竟存在着几十个客户端，所以维护着NameServer，让它将客户端与Broker进行连接，从而进行消息的生产和消费。</li>
</ul>
<h4 id="路由注册"><a href="#路由注册" class="headerlink" title="路由注册"></a>路由注册</h4><p>NameServer通常以集群的方式进行部署，并且都是无状态的，相互之间不进行通信。优点：部署简单，缺点：因为Broker必须指出所有NameServer的地址，所以当有新的NameServer启动时，需要Broker去指定（指定的话需要暂停MQ的生产和消费功能，修改配置文件），如果不去指定，就会导致Broker无法注册到NameServer。</p>
<p><strong>当Broker启动的时候，就会去轮询NameServer列表，发起注册请求，建立长连接。而NameServer维护者一个注册表，记录着所有注册过而且还存活着的Broker。</strong></p>
<p>Broker为了证明自己还活着，就会向NameServer每隔30秒发送一个<strong>心跳包</strong>，告诉NameServer自己还活着，NameServer就会对该Broker注册表里时间戳进行更新。记录其Broker的Id、名称、所属集群。</p>
<h4 id="路由剔除"><a href="#路由剔除" class="headerlink" title="路由剔除"></a>路由剔除</h4><p>每隔10秒NameServer就会扫描注册表，发现有Broker没有发送心跳，就会将该Broker剔除。</p>
<h4 id="路由发现"><a href="#路由发现" class="headerlink" title="路由发现"></a>路由发现</h4><p>因为MQ采用Pull模型，所以当NameServer有路由信息发生变动的时候，不会主动去告诉客户端（生产者和消费者），所以需要客户端发起请求的时候才会拉取路由信息，而且每隔一段时间。默认30秒</p>
<blockquote>
<ul>
<li><strong>pull模型：</strong>每隔一段时间进行一次拉取。优点：能处理大的请求，缺点：实时性很差。</li>
<li><strong>push模型：</strong>推送模型，维护一个长连接，每当有数据，就传输数据过去。优点：实时性较高，缺点：处理不到大的请求。</li>
<li><strong>Long Polling模型：</strong>长轮询模型，对Push和Pull的整合，先发起长连接看是否有数据，没有数据，则等待一段时间，还是没有，在返回通知。充分利用这两个的优点，避免了优点。</li>
</ul>
</blockquote>
<h4 id="NameServer选择策略"><a href="#NameServer选择策略" class="headerlink" title="NameServer选择策略"></a>NameServer选择策略</h4><p> 首先客户端需要配置上NameServer的地址，然后客户端会产生一个随机数对NameServer的数量取模，得到连接索引，进行连接，如果连接失败就会采用round-robin策略，逐个尝试其他的节点。</p>
<h3 id="4、Broker"><a href="#4、Broker" class="headerlink" title="4、Broker"></a>4、Broker</h3><p>主要用来接受生产者生产的消息，并且将这些信息进行一个存储，消费者则可以通过它进行消息的拉取。同时还存储着一些元数据，比如：消费进度的offset、主题、队列等。</p>
<p>构成：主要有一个Remoting Module（远程处理模块）构成，负责客户端的请求。他由下面四个大模块构成。</p>
<ol>
<li><strong>Client Manager：</strong>负责接受、解析客户端的请求（生产者/消费者），管理客户端。</li>
<li><strong>Store Service：</strong>存储服务，调用一些API，然后进行消息的存储。</li>
<li><strong>HA Service：</strong>高可用服务，记录Master和slave的关系。</li>
<li><strong>Index Service：</strong>索引服务，可以让客户端根据key进行消息查询，其中有索引帮其加快查询速度。</li>
</ol>
<p><img data-src="https://s3.bmp.ovh/imgs/2023/06/05/23d54e431cb89bdb.png" class="lazyload"></p>
<h3 id="5、执行流程"><a href="#5、执行流程" class="headerlink" title="5、执行流程"></a>5、执行流程</h3><ol>
<li><strong>启动NameServer，等待Broker、Producer、Comsumer的连接</strong></li>
<li><strong>启动Broker，Broker会轮询跟每个NameServer发起注册请求，进行长连接，NameServer会维护一个路由表，用户记录Broker的状态，并且Broker每隔30秒向NameServer发送一次心跳包</strong></li>
<li><strong>发送消息之前，可以创建Topic，Topic可以指定Broker，会将Topic与Broker的关系记录到NameServer中。也可以不创建，等发消息的时候创建。</strong></li>
<li><strong>Producer发送消息，会采用算法选择一个NameServer进行长连接，并从NameServer中获<br>取路由信息，即当前发送的Topic消息的Queue与Broker的地址（IP+Port）的映射关系，并且会在Producer本地备份一个路由信息，每30秒进行更新一次，然后与Broker进行长连接，再根据策略算法选择一个Queue，将信息发送至Queue中。</strong></li>
<li><strong>Comsumer与Producer类似，先选择一个NameServer进行长连接，获得与 Broker的路由信息，即Topic消息的Queue与Broker地址的映射关系，然后会在本地备份一次路由信息，30秒更新一次，然后与Broker进行长连接，最后消费其消息。</strong></li>
</ol>
<h5 id="Topic的创建模式"><a href="#Topic的创建模式" class="headerlink" title="Topic的创建模式"></a>Topic的创建模式</h5><p>手动创建Topic时，有两种模式：<br>集群模式：该模式下创建的Topic在该集群中，所有Broker中的Queue数量是相同的。<br>Broker模式：该模式下创建的Topic在该集群中，每个Broker中的Queue数量可以不同。<br>自动创建Topic时，默认采用的是Broker模式，会为每个Broker默认创建4个Queue</p>
<h2 id="二、集群搭建理论"><a href="#二、集群搭建理论" class="headerlink" title="二、集群搭建理论"></a>二、集群搭建理论</h2><h3 id="1、数据复制与刷盘策略"><a href="#1、数据复制与刷盘策略" class="headerlink" title="1、数据复制与刷盘策略"></a>1、数据复制与刷盘策略</h3><p><img data-src="https://s3.bmp.ovh/imgs/2023/06/05/55dfe09489145504.png" class="lazyload"></p>
<p>在进行集群搭建时，需要知道MQ集群的同步和持久化策略。</p>
<h4 id="复制策略"><a href="#复制策略" class="headerlink" title="复制策略"></a>复制策略</h4><ul>
<li><strong>同步复制：</strong>将master数据同步到slave并且同步完的时候，才返回ack给Master。效率低，数据完整性高。</li>
<li><strong>异步复制：</strong>master接受到producer的数据后，立马给master返回ack。效率高，吞吐量高。数据完整性低。</li>
</ul>
<h4 id="刷盘策略"><a href="#刷盘策略" class="headerlink" title="刷盘策略"></a>刷盘策略</h4><ul>
<li><p><strong>同步刷盘：</strong>当消息写入到broker的磁盘的时候才代表写入成功。</p>
</li>
<li><p><strong>异步刷盘：</strong>当消息写入到broker的内存的时候就直接返回写入成功，无需等待写入磁盘的过程。</p>
<blockquote>
<p>有点像redis的AOF，会写入到缓冲区pageCache，等到一定的信息的时候，才把这一部分的数据写入到磁盘。避免频繁的IO。</p>
</blockquote>
</li>
</ul>
<h3 id="2、Broker集群模式"><a href="#2、Broker集群模式" class="headerlink" title="2、Broker集群模式"></a>2、Broker集群模式</h3><h4 id="单Master"><a href="#单Master" class="headerlink" title="单Master"></a>单Master</h4><p>单点故障。</p>
<h4 id="多Master多Slave-异步复制"><a href="#多Master多Slave-异步复制" class="headerlink" title="多Master多Slave - 异步复制"></a>多Master多Slave - 异步复制</h4><p>可以有多个Master，每个Master可以有多个Slave，Master负责数据的读写，Slave只负责数据的存储和时刻等待与替代Master，但slave替换Master有一段时间间隔，也有少部分数据丢失。因为采用异步复制，所以当producer将数据交给Master的时候就立即返回ACK， 不保证Slave是否备份完整。</p>
<h4 id="多Master多Slave-同步复制"><a href="#多Master多Slave-同步复制" class="headerlink" title="多Master多Slave - 同步复制"></a>多Master多Slave - 同步复制</h4><p>所谓同步双写，指的是消息写入master成功后，master会等待slave同步数据成功后才向producer返回成功ACK，即master与slave都要写入成功后才会返回成功ACK，也即双写。效率比异步低10%</p>
<h4 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h4><p>多Master+RAID阵列</p>
<h2 id="三、工作原理"><a href="#三、工作原理" class="headerlink" title="三、工作原理"></a>三、工作原理</h2><h3 id="1、消息生产"><a href="#1、消息生产" class="headerlink" title="1、消息生产"></a>1、消息生产</h3><ol>
<li><strong>producer会向NameServer发送一个消息Topic的路由信息请求。</strong></li>
<li><strong>NameServer接受到这个请求的时候，会向producer发送路由表和broker表。</strong></li>
<li><strong>producer接受这两个表信息时，会在本地存储一份，并且根据选择队列的算法，选择一个队列，为后续存储消息做准备。</strong></li>
<li><strong>producer会对这些消息进行一个特殊处理，比如消息超过4M，进行压缩.</strong></li>
<li><strong>producer会向broker进行RPC请求，然后开始发送数据。</strong></li>
</ol>
<h4 id="数据投递Queue算法"><a href="#数据投递Queue算法" class="headerlink" title="数据投递Queue算法"></a>数据投递Queue算法</h4><p>也称消息投递算法，<strong>两种：</strong></p>
<ul>
<li><p><strong>轮询算法：</strong>均衡的向每个Queue分发消息。</p>
<p><strong>缺点：</strong>当有大消息过来时，会造成一个消息的阻塞，生产的很慢。</p>
</li>
<li><p><strong>最小延迟投递算法：</strong>每次发消息都会统计其延时时间，然后找到最小的那条Queue，让他发送，如果都相同，采用轮询算法。</p>
<p><strong>缺点：</strong>如果一直采用最小的那条Queue，导致消息分配不均，吞吐量较小了，导致消息进一步挤压。对消费者也会增大压力。</p>
</li>
</ul>
<h3 id="2、消息存储"><a href="#2、消息存储" class="headerlink" title="2、消息存储"></a>2、消息存储</h3><p>MQ消息存储一般存储再主用户目录下的store目录下。</p>
<p><img data-src="https://s3.bmp.ovh/imgs/2023/06/06/cde7ad0609a56019.png" class="lazyload"></p>
<p>abort：当启动Broker的时候，就会启动，关闭Broker，abort也会消失。如果存在abort，不存在Broker，说明Broker是非正常关闭的。</p>
<p>checkpoint：记录commitlog、consumequeue、index最后一次刷盘的时间戳。</p>
<p><strong>commitlog：</strong>提交日志，记录着每一条Topic的消息。</p>
<p><strong>config：</strong>对Broker的一些配置。</p>
<p><strong>consumequeue：</strong>存放着队列。</p>
<p>index：消息索引文件</p>
<p>lock：运行期间的全局资源锁。</p>
<h4 id="commitlog"><a href="#commitlog" class="headerlink" title="commitlog"></a>commitlog</h4><blockquote>
<p>虽然叫commitlog，但在源码中叫的是mappedFile</p>
</blockquote>
<h5 id="目录与文件"><a href="#目录与文件" class="headerlink" title="目录与文件"></a>目录与文件</h5><p><strong>commitlog存放着很多mappedFile文件，消息就存放在mappedFile中，一个mappedFile大概存储1G文件，如果满了会开辟新的mappedFile，文件名就由20位二进制树构成。</strong>表示第一个消息的偏移量，所以第一个文件都是20个0开头，第二个文件，如果第一个文件满了1G，那就会在第二个文件将1G换算成20位二进制作为文件名。</p>
<p>值得注意的是，<strong>一个Broker对应一个commitlog目录</strong>，所有的mappedFile都存放在这个目录中。所以无论Broker有多少个Topic信息都会存放在这些mappedFile中。并会按照Topic进行分类。</p>
<h5 id="消息单元"><a href="#消息单元" class="headerlink" title="消息单元"></a>消息单元</h5><p><img data-src="https://s3.bmp.ovh/imgs/2023/06/06/47258ecf201d01b2.png" class="lazyload"></p>
<p>消息单元存储在mappedFile中，存储着消息总长度、物理地址、消息Body、消息主题Topic、QueueId、生产者、消息发送时间戳等。</p>
<h3 id="3、consumequeue"><a href="#3、consumequeue" class="headerlink" title="3、consumequeue"></a>3、consumequeue</h3><p><img data-src="https://s3.bmp.ovh/imgs/2023/06/06/a805af796aa41996.png" class="lazyload"></p>
<h4 id="目录与文件-1"><a href="#目录与文件-1" class="headerlink" title="目录与文件"></a>目录与文件</h4><p>为了提高效率，consumequeue目录下，<strong>还创建了Topic目录，然后Topic目录下才存放着相应的queue目录，以queueID存放。consumequeue就是commitlog的索引文件，可以根据consumequeue具体定位到信息。</strong>consumequeue文件名也是20位二进制构成，记录当前文件的偏移量，跟mappedFile不同的是，consumequeue的文件大小固定不变。<strong>consumequeue 文件可以看成是基于 topic 的 commitlog 索引文件</strong></p>
<p><img data-src="https://s3.bmp.ovh/imgs/2023/06/06/6d1afb474ce762bd.png" class="lazyload"></p>
<h4 id="索引条目"><a href="#索引条目" class="headerlink" title="索引条目"></a>索引条目</h4><p><img data-src="https://s3.bmp.ovh/imgs/2023/06/06/71f145502b661d57.png" class="lazyload"></p>
<p>每个consumequeue文件包含了30w个索引条目，这些索引条目主要记载了消息在mappedFile的commitlog offset的偏移量、消息长度、消息Tag的HashCode，</p>
<blockquote>
<p>一个consumequeue文件中所有消息的Topic一定是相同的，但每条Tag消息可能是不同的</p>
</blockquote>
<h3 id="4、broker的持久化"><a href="#4、broker的持久化" class="headerlink" title="4、broker的持久化"></a>4、broker的持久化</h3><p><img data-src="https://s3.bmp.ovh/imgs/2023/06/06/c514ebfb0a7ea17a.png" class="lazyload"></p>
<h4 id="消息写入"><a href="#消息写入" class="headerlink" title="消息写入"></a>消息写入</h4><p>一条消息进入到Broker后经历了以下几个过程才最终被持久化：</p>
<ol>
<li>broker根据queueId，获取该消息对应索引条目在consumequeue目录中写入偏移量，即queueoffset。</li>
<li>对消息进行进一步的封装成消息单元，比如queueId、body等，</li>
<li>将消息写入到commitlog</li>
<li>同时消息形成索引条目</li>
<li>将消息索引条目分到相应的comesumequeue</li>
</ol>
<h4 id="消息拉取"><a href="#消息拉取" class="headerlink" title="消息拉取"></a>消息拉取</h4><p>消费者拉取消息时：</p>
<ol>
<li>当consumer拉取消息时，需要计算出该消息在队列中的偏移量，也就是i消费到哪了</li>
<li>consumer就向broker发送拉取请求，拉取数据，。</li>
<li>broker就计算出conesumerqueue的偏移量</li>
<li>然后就从偏移量开始往后查找第一条指定Tag的索引条目</li>
<li>然后开始解析索引条目的前八位，然后定位到消息commitlog中的commitoffst</li>
<li>从对应的comiitlog读取消息单元，并发送个Consumer。</li>
</ol>
<h4 id="性能提升"><a href="#性能提升" class="headerlink" title="性能提升"></a>性能提升</h4><p>MQ消息都是存储在磁盘上，影响消费嘛？</p>
<p>不影响，有mmap零拷贝。还有PageCache机制</p>
<h3 id="5、indexFile"><a href="#5、indexFile" class="headerlink" title="5、indexFile"></a>5、indexFile</h3><p>没学，感觉不重要。</p>
<h3 id="6、消息的消费"><a href="#6、消息的消费" class="headerlink" title="6、消息的消费"></a>6、消息的消费</h3><p>消费者有两种消费方式：pull模式和push模式。两种消费模式：集群消费Clustering和广播消费Broadcasting。</p>
<h4 id="消费方式"><a href="#消费方式" class="headerlink" title="消费方式"></a>消费方式</h4><h5 id="拉取模式"><a href="#拉取模式" class="headerlink" title="拉取模式"></a>拉取模式</h5><p>Consumer主动从Broker中拉取消息，主动权由Consumer控制。一旦获取了批量消息，就会启动消费过<br>程。不过，该方式的实时性较弱，即Broker中有了新的消息时消费者并不能及时发现并消费。</p>
<blockquote>
<p>由于拉取时间间隔是由用户指定的，所以在设置该间隔时需要注意平稳：间隔太短，空请求比例会增加；间隔太长，消息的实时性太差</p>
</blockquote>
<h5 id="推送模式"><a href="#推送模式" class="headerlink" title="推送模式"></a>推送模式</h5><p><strong>该模式下Broker收到数据后会主动推送给Consumer。该获取方式一般实时性较高。</strong><br>该获取方式是典型的发布-订阅模式，即Consumer向其关联的Queue注册了监听器，一旦发现有新的消息到来就会触发回调的执行，回调方法是Consumer去Queue中拉取消息。而这些都是基于Consumer与Broker间的长连接的。长连接的维护是需要消耗系统资源的。</p>
<h4 id="消费模式"><a href="#消费模式" class="headerlink" title="消费模式"></a>消费模式</h4><h5 id="广播消费"><a href="#广播消费" class="headerlink" title="广播消费"></a>广播消费</h5><p><strong>广播模式下，每条消息都发送给消费组里的每个消费者。</strong></p>
<p><img data-src="https://s3.bmp.ovh/imgs/2023/06/06/c61a11ecb615335f.png" class="lazyload"></p>
<h5 id="集群消费"><a href="#集群消费" class="headerlink" title="集群消费"></a>集群消费</h5><p><strong>集群模式下，消息会平均分摊给每个消费组里面的消费组。</strong></p>
<p><img data-src="https://s3.bmp.ovh/imgs/2023/06/06/a153003c96327f88.png" class="lazyload"></p>
<h4 id="消费进度保存"><a href="#消费进度保存" class="headerlink" title="消费进度保存"></a>消费进度保存</h4><ul>
<li>广播模式：消费进度只会保存在每个消费者组里的消费者，因为在这种模式下，每个消费者消费的进度不同，所以消费者之间保存各自的进度。</li>
<li>集群模式：消费进度保存在Broker里面。因为消费组里面的消费者消费的是同一个Topic下的消息，也就是共享同一个消费进度。下图是broker中存放的各个Topic的各个Queue的消费进度。</li>
</ul>
<p><img data-src="https://s3.bmp.ovh/imgs/2023/06/06/19cad866696aec8c.png" class="lazyload"></p>
<h3 id="7、Rebalance机制"><a href="#7、Rebalance机制" class="headerlink" title="7、Rebalance机制"></a>7、Rebalance机制</h3><p>Rebalance机制讨论的前提是：集群消费。</p>
<h4 id="什么是Rebalance"><a href="#什么是Rebalance" class="headerlink" title="什么是Rebalance"></a>什么是Rebalance</h4><p><strong>就是Consumer的数量变化会促发重新分配。这样做的好处是提高并行消费能力。</strong></p>
<p><img data-src="https://s3.bmp.ovh/imgs/2023/06/06/3375399fd2c2fefd.png" class="lazyload"></p>
<h4 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h4><p>一个队列最多分配一个消费者。所以当消费者数量大于队列数量，剩下多余的消费者不会进行消费，分配不到队列。</p>
<h4 id="危害"><a href="#危害" class="headerlink" title="危害"></a>危害</h4><p>提升消费能力的同时，也会造成一些危害：</p>
<ol>
<li><strong>消费暂停：</strong>当触发rebalance时，原来正在消费的一部分队列会先暂停，等待新的消费者进入或者旧的消费者剔除。</li>
<li><strong>消费重复：</strong>consumer在消费分配给自己的队列时，必须接着上一次消费者的偏移量消费。当有consumer在正常消费数据时，突然宕机，其他一个消费者就会继续从宕机的偏移量重新消费。造成消息重复消费。</li>
<li><strong>消费突刺：</strong>因为rebalance会促发队列的部分暂停，所以会导致消息的挤压，如果暂停时间过长，进一步导致部分队列当rebalance结束时突然猛地消费。</li>
</ol>
<h4 id="产生的原因"><a href="#产生的原因" class="headerlink" title="产生的原因"></a>产生的原因</h4><p>两种：queue发生变化，消费者发生变化</p>
<blockquote>
<p>1）    queue发生数量变化的场景：</p>
<ul>
<li>Broker扩容</li>
<li>Broker升级</li>
<li>Broker与NameServer网络抖动</li>
</ul>
<p>2）消费者发生数量变化的场景：</p>
<ul>
<li>消费者的扩容或缩容</li>
<li>消费者运维升级</li>
<li>消费者与NameServer网络抖动</li>
</ul>
</blockquote>
<h4 id="Rebalance过程"><a href="#Rebalance过程" class="headerlink" title="Rebalance过程"></a>Rebalance过程</h4><p>Broker里面维护着一个Map，key为Topic下的queue信息，value为消费组里面的消费者信息。一旦queue的数量或者消费者的数量发生变化，就会通知消费者组里面的每个消费者进行Rebalance操作。Consumer接受到通知到后会采用<strong>Queue分配算法</strong>，找到自己的queue，然后由Consumer自主进行Rebalance。</p>
<h3 id="8、Queue分配算法"><a href="#8、Queue分配算法" class="headerlink" title="8、Queue分配算法"></a>8、Queue分配算法</h3><p>queue要分赔给哪个消费者也是需要算法决定的，有三个主要策略：</p>
<h4 id="平均分配策略"><a href="#平均分配策略" class="headerlink" title="平均分配策略"></a>平均分配策略</h4><p>就是 <strong>queue的数量 % consumer的数量</strong>，如果能整除，正常分配。不能整除，将剩余下来的消费者从头开始分配。</p>
<p><img data-src="https://s3.bmp.ovh/imgs/2023/06/06/05492f1e2ca90c35.png" class="lazyload"></p>
<h4 id="环形策略"><a href="#环形策略" class="headerlink" title="环形策略"></a>环形策略</h4><p>像发糖果一样，发给每一个小朋友，queue组成一个环，消费者在消费。</p>
<blockquote>
<p>该算法不用事先计算每个Consumer需要分配几个Queue，直接一个一个分即可。</p>
</blockquote>
<p><img alt="1686060395417" data-src="/2023/06/11/RocketMq/Users\qinfeng\AppData\Roaming\Typora\typora-user-images\1686060395417.png" class="lazyload"></p>
<h4 id="一致性哈希"><a href="#一致性哈希" class="headerlink" title="一致性哈希"></a>一致性哈希</h4><p>该算法会将consumer的hash值作为Node节点存放到hash环上，然后将queue的hash值也放到hash环上，通过顺时针方向，距离queue最近的那个consumer就是该queue要分配的consumer。</p>
<blockquote>
<p>该算法存在的问题：分配不均。</p>
</blockquote>
<p><img data-src="https://s3.bmp.ovh/imgs/2023/06/06/71f7ee9a03d3898d.png" class="lazyload"></p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>顶上两种适合简单且分配效率高的。</p>
<p>一致性哈希算法适合consumer经常变换的，因为Rebalance影响较少。</p>
<h4 id="至少一次原则"><a href="#至少一次原则" class="headerlink" title="至少一次原则"></a>至少一次原则</h4><p>RocketMQ有一个原则：每条消息必须要被成功消费一次。<br>那么什么是成功消费呢？Consumer在消费完消息后会向其消费进度记录器提交其消费消息的offset，offset被成功记录到记录器中，那么这条消费就被成功消费了。</p>
<blockquote>
<p>什么是消费进度记录器？<br>对于广播消费模式来说，Consumer本身就是消费进度记录器。<br>对于集群消费模式来说，Broker是消费进度记录器。</p>
</blockquote>
<h3 id="9、订阅关系的一致性"><a href="#9、订阅关系的一致性" class="headerlink" title="9、订阅关系的一致性"></a>9、订阅关系的一致性</h3><h4 id="正确订阅关系"><a href="#正确订阅关系" class="headerlink" title="正确订阅关系"></a>正确订阅关系</h4><p>一个消费者组只能订阅一个Topic，一个消费者组可以订阅多个queue，一个queue可以被多个不同消费组的消费者消费。</p>
<p><img data-src="https://s3.bmp.ovh/imgs/2023/06/06/aeeb93daef751d9d.png" class="lazyload"></p>
<h4 id="不正确的订阅关系"><a href="#不正确的订阅关系" class="headerlink" title="不正确的订阅关系"></a>不正确的订阅关系</h4><p>一个消费者组里面的消费者订阅不同的Topic</p>
<p><img alt="1686061431317" data-src="/2023/06/11/RocketMq/Users\qinfeng\AppData\Roaming\Typora\typora-user-images\1686061431317.png" class="lazyload"></p>
<h3 id="10、offset管理"><a href="#10、offset管理" class="headerlink" title="10、offset管理"></a>10、offset管理</h3><p><strong>这里指的是队列中不同消费者消费的进度</strong>。根据消费记录器的不同，可以分为两种：</p>
<h4 id="本地管理模式"><a href="#本地管理模式" class="headerlink" title="本地管理模式"></a>本地管理模式</h4><p>适用于广播模式，每个消费者保存每个队列中的消费进度，每个消费者不存在消费进度的交集，所以都是采用本地管理。</p>
<blockquote>
<p>Consumer在广播消费模式下offset相关数据以json的形式持久化到Consumer本地磁盘文件中</p>
</blockquote>
<h4 id="远程管理模式"><a href="#远程管理模式" class="headerlink" title="远程管理模式"></a>远程管理模式</h4><p>适用于集群模式，因为每个消费组里的消费者消费同一Topic下的queue，所以他的消费进度是共享的。</p>
<blockquote>
<p>Consumer在集群消费模式下offset相关数据以json的形式持久化到Broker磁盘文件中，</p>
</blockquote>
<p>Broker启动时会加载这个文件，并写入到一个双层Map（ConsumerOffsetManager）。外层map的key为topic@group，value为内层map。内层map的key为queueId，value为offset。当发生Rebalance时，新的Consumer会从该Map中获取到相应的数据来继续消费。<br>集群模式下offset采用远程管理模式，主要是为了保证Rebalance机制。</p>
<h4 id="offset过程"><a href="#offset过程" class="headerlink" title="offset过程"></a>offset过程</h4><p>在代码可以指定我们所需要消费的起始位置：</p>
<ul>
<li>从queue第一条消息开始消费</li>
<li>从queue最后一条消息消费</li>
<li>从时间戳开始消费。</li>
</ul>
<p><img data-src="https://s3.bmp.ovh/imgs/2023/06/06/7042d62d3e26ffe8.png" class="lazyload"></p>
<p><strong>当消费完一批消息后，消费者会向Broker发送消息消费的偏移量，Broker收到这个偏移量的时候，会记录到ConsumerOffsetManager里面，这是一个Map，还有写入到broker的文件中，然后返回给consumer一个ack确认，这个ack记录着下次消息的偏移量，最小偏移量，最大偏移量。</strong></p>
<h4 id="重试队列"><a href="#重试队列" class="headerlink" title="重试队列"></a>重试队列</h4><p>当消息消费异常时，系统在发生消息消费异常时会为当前的topic@group创建一个重试队列，该队列以%RETRY%开头，到达重试时间后进行消费重试。</p>
<p><img data-src="https://s3.bmp.ovh/imgs/2023/06/06/ee9a15835bc38ffa.png" class="lazyload"></p>
<h4 id="offset的同步提交与异步提交"><a href="#offset的同步提交与异步提交" class="headerlink" title="offset的同步提交与异步提交"></a>offset的同步提交与异步提交</h4><p>集群消费模式下，Consumer消费完消息后会向Broker提交消费进度offset，其提交方式分为两种：<br>同步提交：消费者在消费完一批消息后会向broker提交这些消息的offset，然后等待broker的成功响<br>应。若在等待超时之前收到了成功响应，则继续读取下一批消息进行消费（从ACK中获取nextBeginOffset）。若没有收到响应，则会重新提交，直到获取到响应。而在这个等待过程中，消费者是阻塞的。其严重影响了消费者的吞吐量。</p>
<p>异步提交：消费者在消费完一批消息后向broker提交offset，但无需等待Broker的成功响应，可以继续读取并消费下一批消息。这种方式增加了消费者的吞吐量。但需要注意，broker在收到提交的offset后，还是会向消费者进行响应的。可能还没有收到ACK，此时Consumer会从Broker中直接获取nextBeginOffset。</p>
<h3 id="11、消息的幂等性"><a href="#11、消息的幂等性" class="headerlink" title="11、消息的幂等性"></a>11、消息的幂等性</h3><h4 id="什么是幂等性"><a href="#什么是幂等性" class="headerlink" title="什么是幂等性"></a>什么是幂等性</h4><p>就是一次请求和多次相同请求对业务的影响相同，这就叫幂等性。</p>
<h4 id="消费重复的场景分析"><a href="#消费重复的场景分析" class="headerlink" title="消费重复的场景分析"></a>消费重复的场景分析</h4><p>什么情况下会消费重复，以下三种情况：</p>
<h5 id="发送时重复"><a href="#发送时重复" class="headerlink" title="发送时重复"></a>发送时重复</h5><p>当一条消息发送到Broker并持久化时，这个时候由于网络中断，导致Broker未能对生产者的相应，如果此时生产者意识到消息发送失败并尝试再次发送，这个时候Broker就会出现两条内容相同和messageId也相同的消息。</p>
<h5 id="消费时重复"><a href="#消费时重复" class="headerlink" title="消费时重复"></a>消费时重复</h5><p>消息已投递到消费者并执行完业务，此时发送网络中断，消费未能对Broker相应ACK，Broker没有接收到ACK，那么就会从旧的消息偏移量开始，将消息发送出去，此时消费者会接收到同一个MessageId和内容相同的消息。</p>
<p><strong>解决：消费时，根据唯一标识进行过滤。</strong></p>
<h5 id="Rebalance时重复"><a href="#Rebalance时重复" class="headerlink" title="Rebalance时重复"></a>Rebalance时重复</h5><p>当有queue或者消费者的数量发生变动时，会造成Rebalace进而导致消费重复，因为消费者的变化会导致充旧的偏移量重新消费数据。比如5个queue、6个消费者，当第五个消费的消费者挂掉时，无法将消费一半的偏移量返回给Broker，第六个消费者顶上，会接着旧的Broker里的偏移量消费。</p>
<hr>
<h5 id="以下是Java情况"><a href="#以下是Java情况" class="headerlink" title="以下是Java情况"></a>以下是Java情况</h5><ul>
<li><strong>哪些情况下客户端是防止不了重复提交的</strong>？</li>
</ul>
<p>虽然我们可在客户端做一些防止接口重复提交的事（比如将订单按钮置灰，跳转到结果页等）， 但是如下情况依然客户端是很难控制接口重复提交到后台的，这也进一步表明了<strong>接口幂等和防止重复提交不是一回事</strong>以及<strong>后端接口保证接口幂等的必要性</strong>所在。</p>
<ol>
<li><strong>接口超时重试</strong>：接口可能会因为某些原因而调用失败，出于容错性考虑会加上失败重试的机制。如果接口调用一半，再次调用就会因为脏数据的存在而出现异常。</li>
<li><strong>消息重复消费</strong>：在使用消息中间件来处理消息队列，且手动ack确认消息被正常消费时。如果消费者突然断开连接，那么已经执行了一半的消息会重新放回队列。被其他消费者重新消费时就会导致结果异常，如数据库重复数据，数据库数据冲突，资源重复等。</li>
<li><strong>请求重发</strong>：网络抖动引发的nginx重发请求，造成重复调用；</li>
</ol>
<hr>
<h4 id="通用解决方案"><a href="#通用解决方案" class="headerlink" title="通用解决方案"></a>通用解决方案</h4><p><strong>实际过程中主要用：分布式锁+唯一标识</strong></p>
<ol>
<li>当有网络波动重复的请求过来时，使用分布式锁进行拦截，注意锁的key为业务的唯一标识。</li>
<li>请求进来时，根据唯一标识查询Redis中是否存在，存在则说明该业务已经处理，直接返回，不存在说明第一次进来，进入下一步。</li>
<li>进入数据库查询，如果数据库也没有，说明真的是第一次进来，执行业务，更新MySQL，更新Redis。</li>
</ol>
<hr>
<p><strong>还有几种处理方案：Token或者乐观锁</strong></p>
<p><strong>1-1-实现思路</strong><br>为需要保证幂等性的每一次请求创建一个唯一的标识token,先获取token,并将此token存入到redis,请求接口时，将此token放在header或者作为请求参数请求接口，后端接口判断redis中是否存在此token;</p>
<ul>
<li>如果存在，则正常处理业务逻辑，并从redis中删除此token,那么，如果是重复请求，由于token已经被删除，则不能能够通过校验，返回重复提交</li>
<li>如果不存在，说明参数不合法或者是重复请求，返回提示即可</li>
</ul>
<p><strong>1-2-请求流程</strong></p>
<ul>
<li>当页面加载的时候通过接口获取token</li>
<li>当访问接口时，会经过<strong>拦截器</strong>，如果发现该接口中有<strong>自定义的幂等性注解</strong>，说明该接口需要验证幂等性（查看请求头里是否有key=token的值，如果有，并且删除成功，那么接口就访问成功，否则为重复提交；</li>
<li>如果发现该接口没有自定义的幂等性注解，则放行。</li>
</ul>
<hr>
<h3 id="12、消息堆积与消费延迟"><a href="#12、消息堆积与消费延迟" class="headerlink" title="12、消息堆积与消费延迟"></a>12、消息堆积与消费延迟</h3><h4 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h4><p>消息堆积：生产者生产的速度大于消费者消费的速度，导致MQ积压的消息越来越多。</p>
<p>消费延迟：如果是一些实时性很强的业务，消息堆积就会进一步导致消息延迟。</p>
<h4 id="产生原因"><a href="#产生原因" class="headerlink" title="产生原因"></a>产生原因</h4><p>Consumer将本地缓存的消息提交到线程中，使用业务逻辑对消息进行处理，处理完毕后将处理成功的消息返回给Broker，这才将消息消费完毕。消费者的消费能力取决于消息的<strong>消费耗时</strong>和<strong>消费并发</strong>。如果由于业务复杂等原因，导致处理消息时长较长，此时就会导致Consumer本地缓冲队列达到上限，停止从服务端拉取消息。</p>
<h5 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h5><p> 消费堆积的主要原因取决于客户端的消费能力，消费能力取决于消息的<strong>消费耗时和消息并发</strong>。注意消耗耗时的优先级大于消息并发，因为应该在保证消息耗时的基础上，才能进一步优化消息并发。</p>
<h4 id="消费耗时"><a href="#消费耗时" class="headerlink" title="消费耗时"></a>消费耗时</h4><p>影响消耗时长的主要就是一个代码逻辑。而影响消耗时长的主要分两种：一 CPU内部计算型代码，二 外部I/O操作性代码。一般来说CPU的处理是非常快速的，所以主要问题在于外部I/O操作型代码。</p>
<p><strong>I/O操作型代码：</strong></p>
<ul>
<li>读写外部数据库，比如MySQL的远程</li>
<li>读写外部缓存系统，例如对远程Redis的访问</li>
<li>下游系统调用，例如Dubbo的RPC远程调用，Spring Cloud的对下游系统的Http接口调用</li>
</ul>
<h4 id="消费并发度"><a href="#消费并发度" class="headerlink" title="消费并发度"></a>消费并发度</h4><p>消费并发度取决于<strong>单节点线程数和节点数量</strong>，一般是通过调整单节点线程数数量进行优化，不行的话，在横向拓展。</p>
<blockquote>
<p>单节点线程数：一个消费者所包含的线程数</p>
<p>节点数量：一个消费组下的消费者数量。</p>
<p>对于普通消息、延时消息和事务消息的并发度计算都是单节点线程数 * 节点数量，但是对于顺序消息，其并发度等于Topic的queue分区数量。</p>
<p>1）<strong>全局顺序消息：</strong>因为是全局消息，所以该Topic下只允许有一个queue，并且消费者只有一个线程，这样就能保证其消费的有序性。</p>
<p>2）<strong>分区顺序消息：</strong>分区消息，故名该Topic下的queue是分区的，并且有很多queue，为了保证其一个有序性，这些消费者只能由一个线程消费属于自己的queue。能够保证其Topic下的每个queue中的消息被顺序消费，但不能保证其Topic的整体有序。</p>
</blockquote>
<h4 id="如何避免"><a href="#如何避免" class="headerlink" title="如何避免"></a>如何避免</h4><p><strong>消费耗时：</strong></p>
<ol>
<li>查看代码的复杂度是否过高，代码是否存在递归，死循环。</li>
<li>IO操作能否用缓存规避。</li>
<li>消费逻辑中的复杂耗时操作是否可以交给异步去处理，如果可以，是否会造成逻辑混乱。</li>
</ol>
<h5 id="消耗并发度："><a href="#消耗并发度：" class="headerlink" title="消耗并发度："></a><strong>消耗并发度：</strong></h5><ol>
<li>提高消费者的线程数，测试观察，找到一个单个节点最优的值。</li>
</ol>
<h3 id="13、消息的清理"><a href="#13、消息的清理" class="headerlink" title="13、消息的清理"></a>13、消息的清理</h3><p>消息被消费过后会立马删除嘛？不会。</p>
<p>因为消息是存在commitlog文件里面，是以消息单元的形式存在的，如果要单独删除这一条消息无疑是消耗巨大的。<strong>所以commitlog为单位进行清理。</strong></p>
<p>commitlog存在一个<strong>过期时间：72小时</strong>，即3天。除了手动清理外，还存在一下几种情况。</p>
<ul>
<li><strong>文件过期，且到达清理时间点（默认为凌晨4点，因为凌晨人少）后，自动清理过期文件</strong></li>
<li><strong>文件过期，且磁盘空间占用率已达过期清理警戒线（默认75%）后，无论是否达到清理时间点，都会自动清理过期文件</strong></li>
<li>磁盘占用率达到清理警戒线（默认85%）后，开始按照设定好的规则清理文件，无论是否过期。默认会从最老的文件开始清理</li>
<li>磁盘占用率达到系统危险警戒线（默认90%）后，Broker将拒绝消息写入</li>
</ul>
<h2 id="四、应用"><a href="#四、应用" class="headerlink" title="四、应用"></a>四、应用</h2><h3 id="1、普通消息"><a href="#1、普通消息" class="headerlink" title="1、普通消息"></a>1、普通消息</h3><p>消息的发送分为好3种：</p>
<h4 id="同步发送"><a href="#同步发送" class="headerlink" title="同步发送"></a>同步发送</h4><p>producer发送一条消息后，等待Broker返回ack确认后，producer才能继续往下发送。效率较低，但保证了消息的可靠性。</p>
<p><img data-src="https://s3.bmp.ovh/imgs/2023/06/07/3ce9be1d84d9bed5.png" class="lazyload"></p>
<h4 id="异步发送"><a href="#异步发送" class="headerlink" title="异步发送"></a>异步发送</h4><p>发送消息后，不等待broker的确认，接着发送剩下的信息。但能异步收到这些消息的确认信息。效率最高，消息也有一定的可靠性。<strong>异步消费，如果要关闭的话，需要提前假设好睡眠时间，因为异步发送，可能还在发送，就直接关闭，造成报错。</strong></p>
<p><img data-src="https://s3.bmp.ovh/imgs/2023/06/07/d52dcd8eb0d7508d.png" class="lazyload"></p>
<h4 id="单向发送消息"><a href="#单向发送消息" class="headerlink" title="单向发送消息"></a>单向发送消息</h4><p>直接发送消息，不等待ACK，也不处理ACK。效率很高，但消息可靠性不保证</p>
<p><img data-src="https://s3.bmp.ovh/imgs/2023/06/07/43ab188162dca299.png" class="lazyload"></p>
<h3 id="2、顺序消息"><a href="#2、顺序消息" class="headerlink" title="2、顺序消息"></a>2、顺序消息</h3><p><strong>顺序消息指的是生产者生产的消息，消费者顺序消息（FIFO）</strong></p>
<p>消息的发送默认按照轮询方式发送给Topic下不同分区的queue，然后消费者以拉取的方式从queue中拉取数据进行消费，很难保证一个发送和消费是有序的。但如果发送的时候只有一个queue，消费的时候也只有一个队列并且消费者只有一个线程，这个时候能保证消息的顺序性。</p>
<h4 id="为什么需要顺序消息"><a href="#为什么需要顺序消息" class="headerlink" title="为什么需要顺序消息"></a>为什么需要顺序消息</h4><p>因为有些业务中需要一个消息的有序消费，比如一个订单的未支付，已支付，发货中，发货失败，这是个有序任务，当发到不同的queue中时，会造成业务逻辑处理的混乱。</p>
<p><img data-src="https://s3.bmp.ovh/imgs/2023/06/07/7f54285221574466.png" class="lazyload"></p>
<p>所以为了进一步保证有序性，发送消息时就使用一个queue，消费时也就采用要1个队列，并且消费者只有一个线程</p>
<p><img data-src="https://s3.bmp.ovh/imgs/2023/06/07/055b46a75bdf0b31.png" class="lazyload"></p>
<h4 id="有序性分类"><a href="#有序性分类" class="headerlink" title="有序性分类"></a>有序性分类</h4><h4 id="全局有序"><a href="#全局有序" class="headerlink" title="全局有序"></a>全局有序</h4><p>发送消息时只有一个队列，消费时只有一个队列而且只有一个消费线程</p>
<blockquote>
<p>在创建Topic时指定Queue的数量。有三种指定方式：<br>1）在代码中创建Producer时，可以指定其自动创建的Topic的Queue数量<br>2）在RocketMQ可视化控制台中手动创建Topic时指定Queue数量<br>3）使用mqadmin命令手动创建Topic时指定Queue数量</p>
</blockquote>
<p><img data-src="https://s3.bmp.ovh/imgs/2023/06/07/3f3b9e6cec92a1f7.png" class="lazyload"></p>
<h4 id="分区有序"><a href="#分区有序" class="headerlink" title="分区有序"></a>分区有序</h4><p>分区有序指的是同一Topic下，不同分区的queue消费消息的顺序能够保证，当消费者只有一个线程时，不能保证一个Topic下的全局有序。</p>
<h3 id="3、延时消息"><a href="#3、延时消息" class="headerlink" title="3、延时消息"></a>3、延时消息</h3><p>消息进入到broker之后，过段时间才会被消费。</p>
<p><img data-src="https://s3.bmp.ovh/imgs/2023/06/07/6862ec93848561b9.png" class="lazyload"></p>
<h4 id="延时等级"><a href="#延时等级" class="headerlink" title="延时等级"></a>延时等级</h4><p>延时等级对应着其延时时长。</p>
<p><img data-src="https://s3.bmp.ovh/imgs/2023/06/07/4b548f4ccfb17538.png" class="lazyload"></p>
<h4 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h4><p><img data-src="https://s3.bmp.ovh/imgs/2023/06/07/08b491d3e613fb3e.png" class="lazyload"></p>
<ol>
<li><p>当生产者生产一条消息并写入到commitlog，然后准备将该信息分发到相应的consumerqueue队列之前，会判断这个信息是否设置延时等级，如果没有，正常消息。</p>
</li>
<li><p>如果设置了，该消息就会根据延时等级就会进入一个特殊队列SCHEDULE_TOPIC_XXX。</p>
</li>
<li><p>并且会修改原有消息的索引条目，原来的Tag的哈希值修改为投递时间，投递时间指的是进入Broker写入commitlog的时间，然后将该信息放入到特殊队列里。</p>
<p><img data-src="https://s3.bmp.ovh/imgs/2023/06/07/fd9c79b87be88f23.png" class="lazyload"></p>
</li>
<li><p>然后会有一个周期类，这个类会随着broker的启动创建一个定时器，定时的去执行任务，每个等级不同，就会有不同的定时任务，这个类回去查看等级的第一条信息，发现第一条都没有到期，后面队列的肯定没有到期。</p>
</li>
<li><p>有消息到期了，这个类会重新把这个消息从特殊队列拿出来，将原来commitlog的消息的延时等级设置为0，然后投递相应的Topic。</p>
</li>
</ol>
<h3 id="4、事务消息"><a href="#4、事务消息" class="headerlink" title="4、事务消息"></a>4、事务消息</h3><p><strong>RokcetMQ的的分布式事务，只能保证一个生产者到Broker的事务消息，无法保证到消费者的一个事务</strong></p>
<p><strong>分布式事务和普通事务一样，没什么区别，都是保证数据的一致性。最大的区别是保证的范围不一样，分布式是将一个操作划分为若干分支，这些分支部署在不同服务器上，分布式事务就是为了保证这些分支要么全部成功，要么全部失败。</strong></p>
<p>有点难、、、、</p>
<h3 id="5、批量消息"><a href="#5、批量消息" class="headerlink" title="5、批量消息"></a>5、批量消息</h3><p>默认情况下消费者只能消费一个消息，但是可以修改消费者的消费数量来达到批量消费的功能，最多只能拉取32条信息。但是生产者需要注意批量消息不能超过4M，超过4M需要进行消息分割。</p>
<p><strong>发送限制</strong><br>生产者进行消息发送时可以一次发送多条消息，这可以大大提升Producer的发送效率。不过需要注意以下几点：</p>
<blockquote>
<p>批量发送的消息必须具有相同的Topic</p>
<p>批量发送的消息必须具有相同的刷盘策略</p>
<p>批量发送的消息不能是延时消息与事务消息</p>
<p>批量消息不能超过4M</p>
</blockquote>
<h4 id="存在问题"><a href="#存在问题" class="headerlink" title="存在问题"></a>存在问题</h4><p>消费者批量消费是不是批量越多越好？不是</p>
<ul>
<li>若拉取过大，导致每次需要的时间很长，出现错误的可能性就很高，一旦发生错误，那么所有信息要重新拉取。</li>
<li>设置的越大，消费者的并发能力就越低，且这批消息具有相同的结果，因为批量消费指定只有一个线程进行消费，处理过程中出现异常，就要重新消费。</li>
</ul>
<h3 id="6、消息过滤"><a href="#6、消息过滤" class="headerlink" title="6、消息过滤"></a>6、消息过滤</h3><p>除了Topic过滤之外，还存在两种想对比Topic粒度更细的消息过滤。</p>
<ul>
<li>Tag过滤</li>
<li>SQL过滤</li>
</ul>
<h4 id="Tag过滤"><a href="#Tag过滤" class="headerlink" title="Tag过滤"></a>Tag过滤</h4><p>如果消费者要订阅多个Tag，中间用”||“隔开</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DefaultMQPushConsumer consumer = <span class="keyword">new</span></span><br><span class="line">DefaultMQPushConsumer(<span class="string">&quot;CID_EXAMPLE&quot;</span>);</span><br><span class="line">consumer.subscribe(<span class="string">&quot;TOPIC&quot;</span>, <span class="string">&quot;TAGA || TAGB || TAGC&quot;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="SQL过滤"><a href="#SQL过滤" class="headerlink" title="SQL过滤"></a>SQL过滤</h4><p>SQL过滤可以实现复杂的消息过滤，不过只能在PUSH模式下使用。</p>
<p>SQL过滤表达式中支持多种常量类型与运算符。<br>支持的常量类型：</p>
<ul>
<li>数值：比如：123，3.1415</li>
<li>字符：必须用单引号包裹起来，比如：’abc’</li>
<li>布尔：TRUE 或 FALSE</li>
<li>NULL：特殊的常量，表示空</li>
</ul>
<p>支持的运算符有：</p>
<ul>
<li>数值比较：&gt;，&gt;=，&lt;，&lt;=，BETWEEN，=</li>
<li>字符比较：=，&lt;&gt;，IN</li>
<li>逻辑运算 ：AND，OR，NOT</li>
<li>NULL判断：IS NULL 或者 IS NOT NULL</li>
</ul>
<h3 id="7、消息重试"><a href="#7、消息重试" class="headerlink" title="7、消息重试"></a>7、消息重试</h3><h4 id="顺序消息"><a href="#顺序消息" class="headerlink" title="顺序消息"></a>顺序消息</h4><p>对于顺序消息，如果消费不成功，就会不断去重试，并且为了保证其有序性，其他消息会进行一个阻塞。直至消费成功。</p>
<h4 id="无序消息"><a href="#无序消息" class="headerlink" title="无序消息"></a>无序消息</h4><p>无序消息指的是普通消息、延迟消息和事务消息，如果这些发送失败，会间隔一段时间重新发送，而且重试时间会逐渐变长，如果发送16次还是失败，会把该消息扔到死信队列。</p>
<p>重试次数 与上次重试的间隔时间 重试次数 与上次重试的间隔时间<br>1 10秒 9 7分钟<br>2 30秒 10 8分钟<br>3 1分钟 11 9分钟<br>4 2分钟 12 10分钟<br>5 3分钟 13 20分钟<br>6 4分钟 14 30分钟<br>7 5分钟 15 1小时<br>8 6分钟 16 2小时</p>
<h4 id="重试队列-1"><a href="#重试队列-1" class="headerlink" title="重试队列"></a>重试队列</h4><p>对于重试消息，会为其创建一个该Topic下的一个特殊队列，重试队列，当有消息需要重试时，会把这个消息设置延时等级，把他扔到延时队列里面，如果时间到了，就会重新放到重试队列里面，进行重新消费。</p>
<h4 id="重试配置方式"><a href="#重试配置方式" class="headerlink" title="重试配置方式"></a>重试配置方式</h4><p>一般都是在catch中直接返回。</p>
<p>集群消费方式下，消息消费失败后若希望消费重试，则需要在消息监听器接口的实现中明确进行如下三<br>种方式之一的配置：<br>方式1：返回ConsumeConcurrentlyStatus.RECONSUME_LATER（推荐）<br>方式2：返回Null<br>方式3：抛出异常</p>
<p><img data-src="https://s3.bmp.ovh/imgs/2023/06/08/829fcf00314198ac.png" class="lazyload"></p>
<h4 id="不重试配置方式、"><a href="#不重试配置方式、" class="headerlink" title="不重试配置方式、"></a>不重试配置方式、</h4><p>集群消费方式下，消息消费失败后若不希望消费重试，则在捕获到异常后同样也返回与消费成功后的相同的结果，即ConsumeConcurrentlyStatus.CONSUME_SUCCESS，则不进行消费重试。</p>
<p><img data-src="https://s3.bmp.ovh/imgs/2023/06/08/1bedf48c90c84190.png" class="lazyload"></p>
<h3 id="8、死信队列"><a href="#8、死信队列" class="headerlink" title="8、死信队列"></a>8、死信队列</h3><p>当一条消息不断发送失败，达到一个最大的发送失败次数，不会把这个消息丢弃，会把这个消息放到一个特殊的队列，也就是死信队列。死信队列就是用来处理未能正常处理的消息。</p>
<h4 id="特征"><a href="#特征" class="headerlink" title="特征"></a>特征</h4><p>死信队列具有如下特征：</p>
<ul>
<li>死信队列中的消息不会再被消费者正常消费，即DLQ对于消费者是不可见的</li>
<li>死信存储有效期与正常消息相同，均为 3 天（commitlog文件的过期时间），3 天后会被自动删除</li>
<li>死信队列就是一个特殊的Topic，名称为%DLQ%consumerGroup@consumerGroup，即每个消费者组都有一个死信队列</li>
<li>如果⼀个消费者组未产生死信消息，则不会为其创建相应的死信队列</li>
</ul>
<h4 id="处理"><a href="#处理" class="headerlink" title="处理"></a>处理</h4><p>实际上，当⼀条消息进入死信队列，就意味着系统中某些地方出现了问题，从而导致消费者无法正常消<br>费该消息，比如代码中原本就存在Bug。因此，对于死信消息，通常需要开发人员进行特殊处理。最关<br>键的步骤是要排查可疑因素，解决代码中可能存在的Bug，然后再将原来的死信消息再次进行投递消<br>费</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">覃烽</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2023/06/11/RocketMq/">http://example.com/2023/06/11/RocketMq/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com">LuckyFeng的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/RocketMQ/">RocketMQ    </a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button"><i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg"><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2023/06/11/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%92%8C%E7%AE%97%E6%B3%95/"><img class="prev_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>数据结构和算法</span></div></a></div><div class="next-post pull_right"><a href="/2023/06/11/Redis/"><img class="next_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>Redis</span></div></a></div></nav></div></div><footer id="footer" style="background-image: url(https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png)"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2023 By 覃烽</div><div class="framework-info"><span>驱动 </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script id="ribbon" src="/js/third-party/canvas-ribbon.js" size="150" alpha="0.6" zIndex="-1" mobile="true" data-click="true"></script><script id="ribbon_piao" mobile="true" src="/js/third-party/piao.js"></script><script id="canvas_nest" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="true" src="/js/third-party/canvas-nest.js"></script><script src="/js/tw_cn.js"></script><script>translateInitilization()
</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><script src="/js/third-party/click_heart.js"></script></body></html>